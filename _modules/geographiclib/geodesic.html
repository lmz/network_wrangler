

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>geographiclib.geodesic &mdash; Network Wrangler  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Network Wrangler
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../design.html">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autodoc.html">Wrangler Classes and Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../todo.html">To Do List</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Network Wrangler</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>geographiclib.geodesic</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for geographiclib.geodesic</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Define the :class:`~geographiclib.geodesic.Geodesic` class</span>

<span class="sd">The ellipsoid parameters are defined by the constructor.  The direct and</span>
<span class="sd">inverse geodesic problems are solved by</span>

<span class="sd">  * :meth:`~geographiclib.geodesic.Geodesic.Inverse` Solve the inverse</span>
<span class="sd">    geodesic problem</span>
<span class="sd">  * :meth:`~geographiclib.geodesic.Geodesic.Direct` Solve the direct</span>
<span class="sd">    geodesic problem</span>
<span class="sd">  * :meth:`~geographiclib.geodesic.Geodesic.ArcDirect` Solve the direct</span>
<span class="sd">    geodesic problem in terms of spherical arc length</span>

<span class="sd">:class:`~geographiclib.geodesicline.GeodesicLine` objects can be created</span>
<span class="sd">with</span>

<span class="sd">  * :meth:`~geographiclib.geodesic.Geodesic.Line`</span>
<span class="sd">  * :meth:`~geographiclib.geodesic.Geodesic.DirectLine`</span>
<span class="sd">  * :meth:`~geographiclib.geodesic.Geodesic.ArcDirectLine`</span>
<span class="sd">  * :meth:`~geographiclib.geodesic.Geodesic.InverseLine`</span>

<span class="sd">:class:`~geographiclib.polygonarea.PolygonArea` objects can be created</span>
<span class="sd">with</span>

<span class="sd">  * :meth:`~geographiclib.geodesic.Geodesic.Polygon`</span>

<span class="sd">The public attributes for this class are</span>

<span class="sd">  * :attr:`~geographiclib.geodesic.Geodesic.a`</span>
<span class="sd">    :attr:`~geographiclib.geodesic.Geodesic.f`</span>

<span class="sd">*outmask* and *caps* bit masks are</span>

<span class="sd">  * :const:`~geographiclib.geodesic.Geodesic.EMPTY`</span>
<span class="sd">  * :const:`~geographiclib.geodesic.Geodesic.LATITUDE`</span>
<span class="sd">  * :const:`~geographiclib.geodesic.Geodesic.LONGITUDE`</span>
<span class="sd">  * :const:`~geographiclib.geodesic.Geodesic.AZIMUTH`</span>
<span class="sd">  * :const:`~geographiclib.geodesic.Geodesic.DISTANCE`</span>
<span class="sd">  * :const:`~geographiclib.geodesic.Geodesic.STANDARD`</span>
<span class="sd">  * :const:`~geographiclib.geodesic.Geodesic.DISTANCE_IN`</span>
<span class="sd">  * :const:`~geographiclib.geodesic.Geodesic.REDUCEDLENGTH`</span>
<span class="sd">  * :const:`~geographiclib.geodesic.Geodesic.GEODESICSCALE`</span>
<span class="sd">  * :const:`~geographiclib.geodesic.Geodesic.AREA`</span>
<span class="sd">  * :const:`~geographiclib.geodesic.Geodesic.ALL`</span>
<span class="sd">  * :const:`~geographiclib.geodesic.Geodesic.LONG_UNROLL`</span>

<span class="sd">:Example:</span>

<span class="sd">    &gt;&gt;&gt; from geographiclib.geodesic import Geodesic</span>
<span class="sd">    &gt;&gt;&gt; # The geodesic inverse problem</span>
<span class="sd">    ... Geodesic.WGS84.Inverse(-41.32, 174.81, 40.96, -5.50)</span>
<span class="sd">    {&#39;lat1&#39;: -41.32,</span>
<span class="sd">     &#39;a12&#39;: 179.6197069334283,</span>
<span class="sd">     &#39;s12&#39;: 19959679.26735382,</span>
<span class="sd">     &#39;lat2&#39;: 40.96,</span>
<span class="sd">     &#39;azi2&#39;: 18.825195123248392,</span>
<span class="sd">     &#39;azi1&#39;: 161.06766998615882,</span>
<span class="sd">     &#39;lon1&#39;: 174.81,</span>
<span class="sd">     &#39;lon2&#39;: -5.5}</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># geodesic.py</span>
<span class="c1">#</span>
<span class="c1"># This is a rather literal translation of the GeographicLib::Geodesic class to</span>
<span class="c1"># python.  See the documentation for the C++ class for more information at</span>
<span class="c1">#</span>
<span class="c1">#    https://geographiclib.sourceforge.io/html/annotated.html</span>
<span class="c1">#</span>
<span class="c1"># The algorithms are derived in</span>
<span class="c1">#</span>
<span class="c1">#    Charles F. F. Karney,</span>
<span class="c1">#    Algorithms for geodesics, J. Geodesy 87, 43-55 (2013),</span>
<span class="c1">#    https://doi.org/10.1007/s00190-012-0578-z</span>
<span class="c1">#    Addenda: https://geographiclib.sourceforge.io/geod-addenda.html</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) Charles Karney (2011-2017) &lt;charles@karney.com&gt; and licensed</span>
<span class="c1"># under the MIT/X11 License.  For more information, see</span>
<span class="c1"># https://geographiclib.sourceforge.io/</span>
<span class="c1">######################################################################</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">geographiclib.geomath</span> <span class="kn">import</span> <span class="n">Math</span>
<span class="kn">from</span> <span class="nn">geographiclib.constants</span> <span class="kn">import</span> <span class="n">Constants</span>
<span class="kn">from</span> <span class="nn">geographiclib.geodesiccapability</span> <span class="kn">import</span> <span class="n">GeodesicCapability</span>

<div class="viewcode-block" id="Geodesic"><a class="viewcode-back" href="../../_generated/network_wrangler.utils.html#network_wrangler.utils.Geodesic">[docs]</a><span class="k">class</span> <span class="nc">Geodesic</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Solve geodesic problems&quot;&quot;&quot;</span>

  <span class="n">GEOGRAPHICLIB_GEODESIC_ORDER</span> <span class="o">=</span> <span class="mi">6</span>
  <span class="n">nA1_</span> <span class="o">=</span> <span class="n">GEOGRAPHICLIB_GEODESIC_ORDER</span>
  <span class="n">nC1_</span> <span class="o">=</span> <span class="n">GEOGRAPHICLIB_GEODESIC_ORDER</span>
  <span class="n">nC1p_</span> <span class="o">=</span> <span class="n">GEOGRAPHICLIB_GEODESIC_ORDER</span>
  <span class="n">nA2_</span> <span class="o">=</span> <span class="n">GEOGRAPHICLIB_GEODESIC_ORDER</span>
  <span class="n">nC2_</span> <span class="o">=</span> <span class="n">GEOGRAPHICLIB_GEODESIC_ORDER</span>
  <span class="n">nA3_</span> <span class="o">=</span> <span class="n">GEOGRAPHICLIB_GEODESIC_ORDER</span>
  <span class="n">nA3x_</span> <span class="o">=</span> <span class="n">nA3_</span>
  <span class="n">nC3_</span> <span class="o">=</span> <span class="n">GEOGRAPHICLIB_GEODESIC_ORDER</span>
  <span class="n">nC3x_</span> <span class="o">=</span> <span class="p">(</span><span class="n">nC3_</span> <span class="o">*</span> <span class="p">(</span><span class="n">nC3_</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">//</span> <span class="mi">2</span>
  <span class="n">nC4_</span> <span class="o">=</span> <span class="n">GEOGRAPHICLIB_GEODESIC_ORDER</span>
  <span class="n">nC4x_</span> <span class="o">=</span> <span class="p">(</span><span class="n">nC4_</span> <span class="o">*</span> <span class="p">(</span><span class="n">nC4_</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">//</span> <span class="mi">2</span>
  <span class="n">maxit1_</span> <span class="o">=</span> <span class="mi">20</span>
  <span class="n">maxit2_</span> <span class="o">=</span> <span class="n">maxit1_</span> <span class="o">+</span> <span class="n">Math</span><span class="o">.</span><span class="n">digits</span> <span class="o">+</span> <span class="mi">10</span>

  <span class="n">tiny_</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Math</span><span class="o">.</span><span class="n">minval</span><span class="p">)</span>
  <span class="n">tol0_</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">epsilon</span>
  <span class="n">tol1_</span> <span class="o">=</span> <span class="mi">200</span> <span class="o">*</span> <span class="n">tol0_</span>
  <span class="n">tol2_</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tol0_</span><span class="p">)</span>
  <span class="n">tolb_</span> <span class="o">=</span> <span class="n">tol0_</span> <span class="o">*</span> <span class="n">tol2_</span>
  <span class="n">xthresh_</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">tol2_</span>

  <span class="n">CAP_NONE</span> <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">CAP_NONE</span>
  <span class="n">CAP_C1</span>   <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">CAP_C1</span>
  <span class="n">CAP_C1p</span>  <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">CAP_C1p</span>
  <span class="n">CAP_C2</span>   <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">CAP_C2</span>
  <span class="n">CAP_C3</span>   <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">CAP_C3</span>
  <span class="n">CAP_C4</span>   <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">CAP_C4</span>
  <span class="n">CAP_ALL</span>  <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">CAP_ALL</span>
  <span class="n">CAP_MASK</span> <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">CAP_MASK</span>
  <span class="n">OUT_ALL</span>  <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">OUT_ALL</span>
  <span class="n">OUT_MASK</span> <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">OUT_MASK</span>

  <span class="k">def</span> <span class="nf">_SinCosSeries</span><span class="p">(</span><span class="n">sinp</span><span class="p">,</span> <span class="n">sinx</span><span class="p">,</span> <span class="n">cosx</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Private: Evaluate a trig series using Clenshaw summation.&quot;&quot;&quot;</span>
    <span class="c1"># Evaluate</span>
    <span class="c1"># y = sinp ? sum(c[i] * sin( 2*i    * x), i, 1, n) :</span>
    <span class="c1">#            sum(c[i] * cos((2*i+1) * x), i, 0, n-1)</span>
    <span class="c1"># using Clenshaw summation.  N.B. c[0] is unused for sin series</span>
    <span class="c1"># Approx operation count = (n + 5) mult and (2 * n + 2) add</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>                  <span class="c1"># Point to one beyond last element</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">k</span> <span class="o">-</span> <span class="n">sinp</span>
    <span class="n">ar</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">cosx</span> <span class="o">-</span> <span class="n">sinx</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">cosx</span> <span class="o">+</span> <span class="n">sinx</span><span class="p">)</span> <span class="c1"># 2 * cos(2 * x)</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="mi">0</span>                                 <span class="c1"># accumulators for sum</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">k</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">y0</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Now n is even</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="k">while</span> <span class="n">n</span><span class="p">:</span>                    <span class="c1"># while n--:</span>
      <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span>
      <span class="c1"># Unroll loop x 2, so accumulators return to their original role</span>
      <span class="n">k</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">ar</span> <span class="o">*</span> <span class="n">y0</span> <span class="o">-</span> <span class="n">y1</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
      <span class="n">k</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">ar</span> <span class="o">*</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">sinx</span> <span class="o">*</span> <span class="n">cosx</span> <span class="o">*</span> <span class="n">y0</span> <span class="k">if</span> <span class="n">sinp</span> <span class="c1"># sin(2 * x) * y0</span>
             <span class="k">else</span> <span class="n">cosx</span> <span class="o">*</span> <span class="p">(</span><span class="n">y0</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="p">)</span>      <span class="c1"># cos(x) * (y0 - y1)</span>
  <span class="n">_SinCosSeries</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">_SinCosSeries</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_Astroid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Private: solve astroid equation.&quot;&quot;&quot;</span>
    <span class="c1"># Solve k^4+2*k^3-(x^2+y^2-1)*k^2-2*y^2*k-y^2 = 0 for positive root k.</span>
    <span class="c1"># This solution is adapted from Geocentric::Reverse.</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">q</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">6</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">q</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">r</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
      <span class="c1"># Avoid possible division by zero when r = 0 by multiplying equations</span>
      <span class="c1"># for s and t by r^3 and r, resp.</span>
      <span class="n">S</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">q</span> <span class="o">/</span> <span class="mi">4</span>            <span class="c1"># S = r^3 * s</span>
      <span class="n">r2</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
      <span class="n">r3</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">r2</span>
      <span class="c1"># The discriminant of the quadratic equation for T3.  This is zero on</span>
      <span class="c1"># the evolute curve p^(1/3)+q^(1/3) = 1</span>
      <span class="n">disc</span> <span class="o">=</span> <span class="n">S</span> <span class="o">*</span> <span class="p">(</span><span class="n">S</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">r3</span><span class="p">)</span>
      <span class="n">u</span> <span class="o">=</span> <span class="n">r</span>
      <span class="k">if</span> <span class="n">disc</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">T3</span> <span class="o">=</span> <span class="n">S</span> <span class="o">+</span> <span class="n">r3</span>
        <span class="c1"># Pick the sign on the sqrt to maximize abs(T3).  This minimizes loss</span>
        <span class="c1"># of precision due to cancellation.  The result is unchanged because</span>
        <span class="c1"># of the way the T is used in definition of u.</span>
        <span class="n">T3</span> <span class="o">+=</span> <span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">disc</span><span class="p">)</span> <span class="k">if</span> <span class="n">T3</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">disc</span><span class="p">)</span> <span class="c1"># T3 = (r * t)^3</span>
        <span class="c1"># N.B. cbrt always returns the real root.  cbrt(-8) = -2.</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">cbrt</span><span class="p">(</span><span class="n">T3</span><span class="p">)</span>       <span class="c1"># T = r * t</span>
        <span class="c1"># T can be zero; but then r2 / T -&gt; 0.</span>
        <span class="n">u</span> <span class="o">+=</span> <span class="n">T</span> <span class="o">+</span> <span class="p">(</span><span class="n">r2</span> <span class="o">/</span> <span class="n">T</span> <span class="k">if</span> <span class="n">T</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="c1"># T is complex, but the way u is defined the result is real.</span>
        <span class="n">ang</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="o">-</span><span class="n">disc</span><span class="p">),</span> <span class="o">-</span><span class="p">(</span><span class="n">S</span> <span class="o">+</span> <span class="n">r3</span><span class="p">))</span>
        <span class="c1"># There are three possible cube roots.  We choose the root which</span>
        <span class="c1"># avoids cancellation.  Note that disc &lt; 0 implies that r &lt; 0.</span>
        <span class="n">u</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">r</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ang</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
      <span class="n">v</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span><span class="p">)</span> <span class="c1"># guaranteed positive</span>
      <span class="c1"># Avoid loss of accuracy when u &lt; 0.</span>
      <span class="n">uv</span> <span class="o">=</span> <span class="n">q</span> <span class="o">/</span> <span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="n">u</span><span class="p">)</span> <span class="k">if</span> <span class="n">u</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">u</span> <span class="o">+</span> <span class="n">v</span> <span class="c1"># u+v, guaranteed positive</span>
      <span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">uv</span> <span class="o">-</span> <span class="n">q</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span><span class="p">)</span>               <span class="c1"># positive?</span>
      <span class="c1"># Rearrange expression for k to avoid loss of accuracy due to</span>
      <span class="c1"># subtraction.  Division by 0 not possible because uv &gt; 0, w &gt;= 0.</span>
      <span class="n">k</span> <span class="o">=</span> <span class="n">uv</span> <span class="o">/</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">uv</span> <span class="o">+</span> <span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span> <span class="c1"># guaranteed positive</span>
    <span class="k">else</span><span class="p">:</span>                                       <span class="c1"># q == 0 &amp;&amp; r &lt;= 0</span>
      <span class="c1"># y = 0 with |x| &lt;= 1.  Handle this case directly.</span>
      <span class="c1"># for y small, positive root is k = abs(y)/sqrt(1-x^2)</span>
      <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">k</span>
  <span class="n">_Astroid</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">_Astroid</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_A1m1f</span><span class="p">(</span><span class="n">eps</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Private: return A1-1.&quot;&quot;&quot;</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="p">[</span>
      <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">nA1_</span><span class="o">//</span><span class="mi">2</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="n">eps</span><span class="p">))</span> <span class="o">/</span> <span class="n">coeff</span><span class="p">[</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">eps</span><span class="p">)</span>
  <span class="n">_A1m1f</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">_A1m1f</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_C1f</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Private: return C1.&quot;&quot;&quot;</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="p">[</span>
      <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
      <span class="o">-</span><span class="mi">9</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="o">-</span><span class="mi">128</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span>
      <span class="mi">9</span><span class="p">,</span> <span class="o">-</span><span class="mi">16</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span>
      <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span>
      <span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span>
      <span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">eps2</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="n">eps</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">eps</span>
    <span class="n">o</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">nC1_</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span> <span class="c1"># l is index of C1p[l]</span>
      <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">nC1_</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>        <span class="c1"># order of polynomial in eps^2</span>
      <span class="n">c</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">eps2</span><span class="p">)</span> <span class="o">/</span> <span class="n">coeff</span><span class="p">[</span><span class="n">o</span> <span class="o">+</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
      <span class="n">o</span> <span class="o">+=</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">2</span>
      <span class="n">d</span> <span class="o">*=</span> <span class="n">eps</span>
  <span class="n">_C1f</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">_C1f</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_C1pf</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Private: return C1&#39;&quot;&quot;&quot;</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="p">[</span>
      <span class="mi">205</span><span class="p">,</span> <span class="o">-</span><span class="mi">432</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span> <span class="mi">1536</span><span class="p">,</span>
      <span class="mi">4005</span><span class="p">,</span> <span class="o">-</span><span class="mi">4736</span><span class="p">,</span> <span class="mi">3840</span><span class="p">,</span> <span class="mi">12288</span><span class="p">,</span>
      <span class="o">-</span><span class="mi">225</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">384</span><span class="p">,</span>
      <span class="o">-</span><span class="mi">7173</span><span class="p">,</span> <span class="mi">2695</span><span class="p">,</span> <span class="mi">7680</span><span class="p">,</span>
      <span class="mi">3467</span><span class="p">,</span> <span class="mi">7680</span><span class="p">,</span>
      <span class="mi">38081</span><span class="p">,</span> <span class="mi">61440</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">eps2</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="n">eps</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">eps</span>
    <span class="n">o</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">nC1p_</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span> <span class="c1"># l is index of C1p[l]</span>
      <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">nC1p_</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="c1"># order of polynomial in eps^2</span>
      <span class="n">c</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">eps2</span><span class="p">)</span> <span class="o">/</span> <span class="n">coeff</span><span class="p">[</span><span class="n">o</span> <span class="o">+</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
      <span class="n">o</span> <span class="o">+=</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">2</span>
      <span class="n">d</span> <span class="o">*=</span> <span class="n">eps</span>
  <span class="n">_C1pf</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">_C1pf</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_A2m1f</span><span class="p">(</span><span class="n">eps</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Private: return A2-1&quot;&quot;&quot;</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="p">[</span>
      <span class="o">-</span><span class="mi">11</span><span class="p">,</span> <span class="o">-</span><span class="mi">28</span><span class="p">,</span> <span class="o">-</span><span class="mi">192</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">nA2_</span><span class="o">//</span><span class="mi">2</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="n">eps</span><span class="p">))</span> <span class="o">/</span> <span class="n">coeff</span><span class="p">[</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">eps</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span>
  <span class="n">_A2m1f</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">_A2m1f</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_C2f</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Private: return C2&quot;&quot;&quot;</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="p">[</span>
      <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
      <span class="mi">35</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">384</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span>
      <span class="mi">15</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span>
      <span class="mi">7</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span>
      <span class="mi">63</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span>
      <span class="mi">77</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">eps2</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="n">eps</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">eps</span>
    <span class="n">o</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">nC2_</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span> <span class="c1"># l is index of C2[l]</span>
      <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">nC2_</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>        <span class="c1"># order of polynomial in eps^2</span>
      <span class="n">c</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">eps2</span><span class="p">)</span> <span class="o">/</span> <span class="n">coeff</span><span class="p">[</span><span class="n">o</span> <span class="o">+</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
      <span class="n">o</span> <span class="o">+=</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">2</span>
      <span class="n">d</span> <span class="o">*=</span> <span class="n">eps</span>
  <span class="n">_C2f</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">_C2f</span><span class="p">)</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Construct a Geodesic object</span>

<span class="sd">    :param a: the equatorial radius of the ellipsoid in meters</span>
<span class="sd">    :param f: the flattening of the ellipsoid</span>

<span class="sd">    An exception is thrown if *a* or the polar semi-axis *b* = *a* (1 -</span>
<span class="sd">    *f*) is not a finite positive quantity.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;The equatorial radius in meters (readonly)&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;The flattening (readonly)&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_f1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_e2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_ep2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_e2</span> <span class="o">/</span> <span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_f1</span><span class="p">)</span> <span class="c1"># e2 / (1 - e2)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">/</span> <span class="p">(</span> <span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f1</span>
    <span class="c1"># authalic radius squared</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_c2</span> <span class="o">=</span> <span class="p">(</span><span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_b</span><span class="p">)</span> <span class="o">*</span>
                <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_e2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span>
                 <span class="p">(</span><span class="n">Math</span><span class="o">.</span><span class="n">atanh</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_e2</span><span class="p">))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_e2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span>
                  <span class="n">math</span><span class="o">.</span><span class="n">atan</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_e2</span><span class="p">)))</span> <span class="o">/</span>
                 <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_e2</span><span class="p">))))</span><span class="o">/</span><span class="mi">2</span>
    <span class="c1"># The sig12 threshold for &quot;really short&quot;.  Using the auxiliary sphere</span>
    <span class="c1"># solution with dnm computed at (bet1 + bet2) / 2, the relative error in</span>
    <span class="c1"># the azimuth consistency check is sig12^2 * abs(f) * min(1, 1-f/2) / 2.</span>
    <span class="c1"># (Error measured for 1/100 &lt; b/a &lt; 100 and abs(f) &gt;= 1/1000.  For a given</span>
    <span class="c1"># f and sig12, the max error occurs for lines near the pole.  If the old</span>
    <span class="c1"># rule for computing dnm = (dn1 + dn2)/2 is used, then the error increases</span>
    <span class="c1"># by a factor of 2.)  Setting this equal to epsilon gives sig12 = etol2.</span>
    <span class="c1"># Here 0.1 is a safety factor (error decreased by 100) and max(0.001,</span>
    <span class="c1"># abs(f)) stops etol2 getting too large in the nearly spherical case.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_etol2</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">tol2_</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">))</span> <span class="o">*</span>
                                                    <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">Math</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Equatorial radius is not positive&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">Math</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_b</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Polar semi-axis is not positive&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_A3x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">nA3x_</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_C3x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">nC3x_</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_C4x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">nC4x_</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_A3coeff</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_C3coeff</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_C4coeff</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">_A3coeff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Private: return coefficients for A3&quot;&quot;&quot;</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="p">[</span>
      <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span>
      <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span>
      <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span>
      <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
      <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
      <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">o</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">nA3_</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># coeff of eps^j</span>
      <span class="n">m</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">nA3_</span> <span class="o">-</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="c1"># order of polynomial in n</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_A3x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span><span class="p">)</span> <span class="o">/</span> <span class="n">coeff</span><span class="p">[</span><span class="n">o</span> <span class="o">+</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
      <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">o</span> <span class="o">+=</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">2</span>

  <span class="k">def</span> <span class="nf">_C3coeff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Private: return coefficients for C3&quot;&quot;&quot;</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="p">[</span>
      <span class="mi">3</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span>
      <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span>
      <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span>
      <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
      <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
      <span class="mi">5</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span>
      <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span>
      <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span>
      <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
      <span class="mi">7</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span>
      <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">384</span><span class="p">,</span>
      <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span>
      <span class="mi">7</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span>
      <span class="o">-</span><span class="mi">14</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span>
      <span class="mi">21</span><span class="p">,</span> <span class="mi">2560</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">o</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">nC3_</span><span class="p">):</span> <span class="c1"># l is index of C3[l]</span>
      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">nC3_</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># coeff of eps^j</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">nC3_</span> <span class="o">-</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="c1"># order of polynomial in n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_C3x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span><span class="p">)</span> <span class="o">/</span> <span class="n">coeff</span><span class="p">[</span><span class="n">o</span> <span class="o">+</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">o</span> <span class="o">+=</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">2</span>

  <span class="k">def</span> <span class="nf">_C4coeff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Private: return coefficients for C4&quot;&quot;&quot;</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="p">[</span>
      <span class="mi">97</span><span class="p">,</span> <span class="mi">15015</span><span class="p">,</span>
      <span class="mi">1088</span><span class="p">,</span> <span class="mi">156</span><span class="p">,</span> <span class="mi">45045</span><span class="p">,</span>
      <span class="o">-</span><span class="mi">224</span><span class="p">,</span> <span class="o">-</span><span class="mi">4784</span><span class="p">,</span> <span class="mi">1573</span><span class="p">,</span> <span class="mi">45045</span><span class="p">,</span>
      <span class="o">-</span><span class="mi">10656</span><span class="p">,</span> <span class="mi">14144</span><span class="p">,</span> <span class="o">-</span><span class="mi">4576</span><span class="p">,</span> <span class="o">-</span><span class="mi">858</span><span class="p">,</span> <span class="mi">45045</span><span class="p">,</span>
      <span class="mi">64</span><span class="p">,</span> <span class="mi">624</span><span class="p">,</span> <span class="o">-</span><span class="mi">4576</span><span class="p">,</span> <span class="mi">6864</span><span class="p">,</span> <span class="o">-</span><span class="mi">3003</span><span class="p">,</span> <span class="mi">15015</span><span class="p">,</span>
      <span class="mi">100</span><span class="p">,</span> <span class="mi">208</span><span class="p">,</span> <span class="mi">572</span><span class="p">,</span> <span class="mi">3432</span><span class="p">,</span> <span class="o">-</span><span class="mi">12012</span><span class="p">,</span> <span class="mi">30030</span><span class="p">,</span> <span class="mi">45045</span><span class="p">,</span>
      <span class="mi">1</span><span class="p">,</span> <span class="mi">9009</span><span class="p">,</span>
      <span class="o">-</span><span class="mi">2944</span><span class="p">,</span> <span class="mi">468</span><span class="p">,</span> <span class="mi">135135</span><span class="p">,</span>
      <span class="mi">5792</span><span class="p">,</span> <span class="mi">1040</span><span class="p">,</span> <span class="o">-</span><span class="mi">1287</span><span class="p">,</span> <span class="mi">135135</span><span class="p">,</span>
      <span class="mi">5952</span><span class="p">,</span> <span class="o">-</span><span class="mi">11648</span><span class="p">,</span> <span class="mi">9152</span><span class="p">,</span> <span class="o">-</span><span class="mi">2574</span><span class="p">,</span> <span class="mi">135135</span><span class="p">,</span>
      <span class="o">-</span><span class="mi">64</span><span class="p">,</span> <span class="o">-</span><span class="mi">624</span><span class="p">,</span> <span class="mi">4576</span><span class="p">,</span> <span class="o">-</span><span class="mi">6864</span><span class="p">,</span> <span class="mi">3003</span><span class="p">,</span> <span class="mi">135135</span><span class="p">,</span>
      <span class="mi">8</span><span class="p">,</span> <span class="mi">10725</span><span class="p">,</span>
      <span class="mi">1856</span><span class="p">,</span> <span class="o">-</span><span class="mi">936</span><span class="p">,</span> <span class="mi">225225</span><span class="p">,</span>
      <span class="o">-</span><span class="mi">8448</span><span class="p">,</span> <span class="mi">4992</span><span class="p">,</span> <span class="o">-</span><span class="mi">1144</span><span class="p">,</span> <span class="mi">225225</span><span class="p">,</span>
      <span class="o">-</span><span class="mi">1440</span><span class="p">,</span> <span class="mi">4160</span><span class="p">,</span> <span class="o">-</span><span class="mi">4576</span><span class="p">,</span> <span class="mi">1716</span><span class="p">,</span> <span class="mi">225225</span><span class="p">,</span>
      <span class="o">-</span><span class="mi">136</span><span class="p">,</span> <span class="mi">63063</span><span class="p">,</span>
      <span class="mi">1024</span><span class="p">,</span> <span class="o">-</span><span class="mi">208</span><span class="p">,</span> <span class="mi">105105</span><span class="p">,</span>
      <span class="mi">3584</span><span class="p">,</span> <span class="o">-</span><span class="mi">3328</span><span class="p">,</span> <span class="mi">1144</span><span class="p">,</span> <span class="mi">315315</span><span class="p">,</span>
      <span class="o">-</span><span class="mi">128</span><span class="p">,</span> <span class="mi">135135</span><span class="p">,</span>
      <span class="o">-</span><span class="mi">2560</span><span class="p">,</span> <span class="mi">832</span><span class="p">,</span> <span class="mi">405405</span><span class="p">,</span>
      <span class="mi">128</span><span class="p">,</span> <span class="mi">99099</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">o</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">nC4_</span><span class="p">):</span> <span class="c1"># l is index of C4[l]</span>
      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">nC4_</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># coeff of eps^j</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">nC4_</span> <span class="o">-</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span> <span class="c1"># order of polynomial in n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_C4x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n</span><span class="p">)</span> <span class="o">/</span> <span class="n">coeff</span><span class="p">[</span><span class="n">o</span> <span class="o">+</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">o</span> <span class="o">+=</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">2</span>

  <span class="k">def</span> <span class="nf">_A3f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eps</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Private: return A3&quot;&quot;&quot;</span>
    <span class="c1"># Evaluate A3</span>
    <span class="k">return</span> <span class="n">Math</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">nA3_</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_A3x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_C3f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Private: return C3&quot;&quot;&quot;</span>
    <span class="c1"># Evaluate C3</span>
    <span class="c1"># Elements c[1] thru c[nC3_ - 1] are set</span>
    <span class="n">mult</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">o</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">nC3_</span><span class="p">):</span> <span class="c1"># l is index of C3[l]</span>
      <span class="n">m</span> <span class="o">=</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">nC3_</span> <span class="o">-</span> <span class="n">l</span> <span class="o">-</span> <span class="mi">1</span>       <span class="c1"># order of polynomial in eps</span>
      <span class="n">mult</span> <span class="o">*=</span> <span class="n">eps</span>
      <span class="n">c</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">mult</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_C3x</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span>
      <span class="n">o</span> <span class="o">+=</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span>

  <span class="k">def</span> <span class="nf">_C4f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Private: return C4&quot;&quot;&quot;</span>
    <span class="c1"># Evaluate C4 coeffs by Horner&#39;s method</span>
    <span class="c1"># Elements c[0] thru c[nC4_ - 1] are set</span>
    <span class="n">mult</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">o</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">nC4_</span><span class="p">):</span> <span class="c1"># l is index of C4[l]</span>
      <span class="n">m</span> <span class="o">=</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">nC4_</span> <span class="o">-</span> <span class="n">l</span> <span class="o">-</span> <span class="mi">1</span>    <span class="c1"># order of polynomial in eps</span>
      <span class="n">c</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">mult</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_C4x</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span>
      <span class="n">o</span> <span class="o">+=</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="n">mult</span> <span class="o">*=</span> <span class="n">eps</span>

  <span class="c1"># return s12b, m12b, m0, M12, M21</span>
  <span class="k">def</span> <span class="nf">_Lengths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">sig12</span><span class="p">,</span>
               <span class="n">ssig1</span><span class="p">,</span> <span class="n">csig1</span><span class="p">,</span> <span class="n">dn1</span><span class="p">,</span> <span class="n">ssig2</span><span class="p">,</span> <span class="n">csig2</span><span class="p">,</span> <span class="n">dn2</span><span class="p">,</span> <span class="n">cbet1</span><span class="p">,</span> <span class="n">cbet2</span><span class="p">,</span> <span class="n">outmask</span><span class="p">,</span>
               <span class="c1"># Scratch areas of the right size</span>
               <span class="n">C1a</span><span class="p">,</span> <span class="n">C2a</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Private: return a bunch of lengths&quot;&quot;&quot;</span>
    <span class="c1"># Return s12b, m12b, m0, M12, M21, where</span>
    <span class="c1"># m12b = (reduced length)/_b; s12b = distance/_b,</span>
    <span class="c1"># m0 = coefficient of secular term in expression for reduced length.</span>
    <span class="n">outmask</span> <span class="o">&amp;=</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">OUT_MASK</span>
    <span class="c1"># outmask &amp; DISTANCE: set s12b</span>
    <span class="c1"># outmask &amp; REDUCEDLENGTH: set m12b &amp; m0</span>
    <span class="c1"># outmask &amp; GEODESICSCALE: set M12 &amp; M21</span>

    <span class="n">s12b</span> <span class="o">=</span> <span class="n">m12b</span> <span class="o">=</span> <span class="n">m0</span> <span class="o">=</span> <span class="n">M12</span> <span class="o">=</span> <span class="n">M21</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">DISTANCE</span> <span class="o">|</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">REDUCEDLENGTH</span> <span class="o">|</span>
                  <span class="n">Geodesic</span><span class="o">.</span><span class="n">GEODESICSCALE</span><span class="p">):</span>
      <span class="n">A1</span> <span class="o">=</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">_A1m1f</span><span class="p">(</span><span class="n">eps</span><span class="p">)</span>
      <span class="n">Geodesic</span><span class="o">.</span><span class="n">_C1f</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="n">C1a</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">REDUCEDLENGTH</span> <span class="o">|</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">GEODESICSCALE</span><span class="p">):</span>
        <span class="n">A2</span> <span class="o">=</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">_A2m1f</span><span class="p">(</span><span class="n">eps</span><span class="p">)</span>
        <span class="n">Geodesic</span><span class="o">.</span><span class="n">_C2f</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="n">C2a</span><span class="p">)</span>
        <span class="n">m0x</span> <span class="o">=</span> <span class="n">A1</span> <span class="o">-</span> <span class="n">A2</span>
        <span class="n">A2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">A2</span>
      <span class="n">A1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">A1</span>
    <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">DISTANCE</span><span class="p">:</span>
      <span class="n">B1</span> <span class="o">=</span> <span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">_SinCosSeries</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">ssig2</span><span class="p">,</span> <span class="n">csig2</span><span class="p">,</span> <span class="n">C1a</span><span class="p">)</span> <span class="o">-</span>
            <span class="n">Geodesic</span><span class="o">.</span><span class="n">_SinCosSeries</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">ssig1</span><span class="p">,</span> <span class="n">csig1</span><span class="p">,</span> <span class="n">C1a</span><span class="p">))</span>
      <span class="c1"># Missing a factor of _b</span>
      <span class="n">s12b</span> <span class="o">=</span> <span class="n">A1</span> <span class="o">*</span> <span class="p">(</span><span class="n">sig12</span> <span class="o">+</span> <span class="n">B1</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">REDUCEDLENGTH</span> <span class="o">|</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">GEODESICSCALE</span><span class="p">):</span>
        <span class="n">B2</span> <span class="o">=</span> <span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">_SinCosSeries</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">ssig2</span><span class="p">,</span> <span class="n">csig2</span><span class="p">,</span> <span class="n">C2a</span><span class="p">)</span> <span class="o">-</span>
              <span class="n">Geodesic</span><span class="o">.</span><span class="n">_SinCosSeries</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">ssig1</span><span class="p">,</span> <span class="n">csig1</span><span class="p">,</span> <span class="n">C2a</span><span class="p">))</span>
        <span class="n">J12</span> <span class="o">=</span> <span class="n">m0x</span> <span class="o">*</span> <span class="n">sig12</span> <span class="o">+</span> <span class="p">(</span><span class="n">A1</span> <span class="o">*</span> <span class="n">B1</span> <span class="o">-</span> <span class="n">A2</span> <span class="o">*</span> <span class="n">B2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">REDUCEDLENGTH</span> <span class="o">|</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">GEODESICSCALE</span><span class="p">):</span>
      <span class="c1"># Assume here that nC1_ &gt;= nC2_</span>
      <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">nC2_</span><span class="p">):</span>
        <span class="n">C2a</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">A1</span> <span class="o">*</span> <span class="n">C1a</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">-</span> <span class="n">A2</span> <span class="o">*</span> <span class="n">C2a</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
      <span class="n">J12</span> <span class="o">=</span> <span class="n">m0x</span> <span class="o">*</span> <span class="n">sig12</span> <span class="o">+</span> <span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">_SinCosSeries</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">ssig2</span><span class="p">,</span> <span class="n">csig2</span><span class="p">,</span> <span class="n">C2a</span><span class="p">)</span> <span class="o">-</span>
                           <span class="n">Geodesic</span><span class="o">.</span><span class="n">_SinCosSeries</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">ssig1</span><span class="p">,</span> <span class="n">csig1</span><span class="p">,</span> <span class="n">C2a</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">REDUCEDLENGTH</span><span class="p">:</span>
      <span class="n">m0</span> <span class="o">=</span> <span class="n">m0x</span>
      <span class="c1"># Missing a factor of _b.</span>
      <span class="c1"># Add parens around (csig1 * ssig2) and (ssig1 * csig2) to ensure</span>
      <span class="c1"># accurate cancellation in the case of coincident points.</span>
      <span class="n">m12b</span> <span class="o">=</span> <span class="p">(</span><span class="n">dn2</span> <span class="o">*</span> <span class="p">(</span><span class="n">csig1</span> <span class="o">*</span> <span class="n">ssig2</span><span class="p">)</span> <span class="o">-</span> <span class="n">dn1</span> <span class="o">*</span> <span class="p">(</span><span class="n">ssig1</span> <span class="o">*</span> <span class="n">csig2</span><span class="p">)</span> <span class="o">-</span>
              <span class="n">csig1</span> <span class="o">*</span> <span class="n">csig2</span> <span class="o">*</span> <span class="n">J12</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">GEODESICSCALE</span><span class="p">:</span>
      <span class="n">csig12</span> <span class="o">=</span> <span class="n">csig1</span> <span class="o">*</span> <span class="n">csig2</span> <span class="o">+</span> <span class="n">ssig1</span> <span class="o">*</span> <span class="n">ssig2</span>
      <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ep2</span> <span class="o">*</span> <span class="p">(</span><span class="n">cbet1</span> <span class="o">-</span> <span class="n">cbet2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">cbet1</span> <span class="o">+</span> <span class="n">cbet2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">dn1</span> <span class="o">+</span> <span class="n">dn2</span><span class="p">)</span>
      <span class="n">M12</span> <span class="o">=</span> <span class="n">csig12</span> <span class="o">+</span> <span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">ssig2</span> <span class="o">-</span> <span class="n">csig2</span> <span class="o">*</span> <span class="n">J12</span><span class="p">)</span> <span class="o">*</span> <span class="n">ssig1</span> <span class="o">/</span> <span class="n">dn1</span>
      <span class="n">M21</span> <span class="o">=</span> <span class="n">csig12</span> <span class="o">-</span> <span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">ssig1</span> <span class="o">-</span> <span class="n">csig1</span> <span class="o">*</span> <span class="n">J12</span><span class="p">)</span> <span class="o">*</span> <span class="n">ssig2</span> <span class="o">/</span> <span class="n">dn2</span>
    <span class="k">return</span> <span class="n">s12b</span><span class="p">,</span> <span class="n">m12b</span><span class="p">,</span> <span class="n">m0</span><span class="p">,</span> <span class="n">M12</span><span class="p">,</span> <span class="n">M21</span>

  <span class="c1"># return sig12, salp1, calp1, salp2, calp2, dnm</span>
  <span class="k">def</span> <span class="nf">_InverseStart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sbet1</span><span class="p">,</span> <span class="n">cbet1</span><span class="p">,</span> <span class="n">dn1</span><span class="p">,</span> <span class="n">sbet2</span><span class="p">,</span> <span class="n">cbet2</span><span class="p">,</span> <span class="n">dn2</span><span class="p">,</span>
                    <span class="n">lam12</span><span class="p">,</span> <span class="n">slam12</span><span class="p">,</span> <span class="n">clam12</span><span class="p">,</span>
                    <span class="c1"># Scratch areas of the right size</span>
                    <span class="n">C1a</span><span class="p">,</span> <span class="n">C2a</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Private: Find a starting value for Newton&#39;s method.&quot;&quot;&quot;</span>
    <span class="c1"># Return a starting point for Newton&#39;s method in salp1 and calp1 (function</span>
    <span class="c1"># value is -1).  If Newton&#39;s method doesn&#39;t need to be used, return also</span>
    <span class="c1"># salp2 and calp2 and function value is sig12.</span>
    <span class="n">sig12</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">salp2</span> <span class="o">=</span> <span class="n">calp2</span> <span class="o">=</span> <span class="n">dnm</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">nan</span> <span class="c1"># Return values</span>
    <span class="c1"># bet12 = bet2 - bet1 in [0, pi); bet12a = bet2 + bet1 in (-pi, 0]</span>
    <span class="n">sbet12</span> <span class="o">=</span> <span class="n">sbet2</span> <span class="o">*</span> <span class="n">cbet1</span> <span class="o">-</span> <span class="n">cbet2</span> <span class="o">*</span> <span class="n">sbet1</span>
    <span class="n">cbet12</span> <span class="o">=</span> <span class="n">cbet2</span> <span class="o">*</span> <span class="n">cbet1</span> <span class="o">+</span> <span class="n">sbet2</span> <span class="o">*</span> <span class="n">sbet1</span>
    <span class="c1"># Volatile declaration needed to fix inverse cases</span>
    <span class="c1"># 88.202499451857 0 -88.202499451857 179.981022032992859592</span>
    <span class="c1"># 89.262080389218 0 -89.262080389218 179.992207982775375662</span>
    <span class="c1"># 89.333123580033 0 -89.333123580032997687 179.99295812360148422</span>
    <span class="c1"># which otherwise fail with g++ 4.4.4 x86 -O3</span>
    <span class="n">sbet12a</span> <span class="o">=</span> <span class="n">sbet2</span> <span class="o">*</span> <span class="n">cbet1</span>
    <span class="n">sbet12a</span> <span class="o">+=</span> <span class="n">cbet2</span> <span class="o">*</span> <span class="n">sbet1</span>

    <span class="n">shortline</span> <span class="o">=</span> <span class="n">cbet12</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sbet12</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="ow">and</span> <span class="n">cbet2</span> <span class="o">*</span> <span class="n">lam12</span> <span class="o">&lt;</span> <span class="mf">0.5</span>
    <span class="k">if</span> <span class="n">shortline</span><span class="p">:</span>
      <span class="n">sbetm2</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="n">sbet1</span> <span class="o">+</span> <span class="n">sbet2</span><span class="p">)</span>
      <span class="c1"># sin((bet1+bet2)/2)^2</span>
      <span class="c1"># =  (sbet1 + sbet2)^2 / ((sbet1 + sbet2)^2 + (cbet1 + cbet2)^2)</span>
      <span class="n">sbetm2</span> <span class="o">/=</span> <span class="n">sbetm2</span> <span class="o">+</span> <span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="n">cbet1</span> <span class="o">+</span> <span class="n">cbet2</span><span class="p">)</span>
      <span class="n">dnm</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ep2</span> <span class="o">*</span> <span class="n">sbetm2</span><span class="p">)</span>
      <span class="n">omg12</span> <span class="o">=</span> <span class="n">lam12</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_f1</span> <span class="o">*</span> <span class="n">dnm</span><span class="p">)</span>
      <span class="n">somg12</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">omg12</span><span class="p">);</span> <span class="n">comg12</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omg12</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">somg12</span> <span class="o">=</span> <span class="n">slam12</span><span class="p">;</span> <span class="n">comg12</span> <span class="o">=</span> <span class="n">clam12</span>

    <span class="n">salp1</span> <span class="o">=</span> <span class="n">cbet2</span> <span class="o">*</span> <span class="n">somg12</span>
    <span class="n">calp1</span> <span class="o">=</span> <span class="p">(</span>
      <span class="n">sbet12</span> <span class="o">+</span> <span class="n">cbet2</span> <span class="o">*</span> <span class="n">sbet1</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="n">somg12</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">comg12</span><span class="p">)</span> <span class="k">if</span> <span class="n">comg12</span> <span class="o">&gt;=</span> <span class="mi">0</span>
      <span class="k">else</span> <span class="n">sbet12a</span> <span class="o">-</span> <span class="n">cbet2</span> <span class="o">*</span> <span class="n">sbet1</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="n">somg12</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">comg12</span><span class="p">))</span>

    <span class="n">ssig12</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">salp1</span><span class="p">,</span> <span class="n">calp1</span><span class="p">)</span>
    <span class="n">csig12</span> <span class="o">=</span> <span class="n">sbet1</span> <span class="o">*</span> <span class="n">sbet2</span> <span class="o">+</span> <span class="n">cbet1</span> <span class="o">*</span> <span class="n">cbet2</span> <span class="o">*</span> <span class="n">comg12</span>

    <span class="k">if</span> <span class="n">shortline</span> <span class="ow">and</span> <span class="n">ssig12</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_etol2</span><span class="p">:</span>
      <span class="c1"># really short lines</span>
      <span class="n">salp2</span> <span class="o">=</span> <span class="n">cbet1</span> <span class="o">*</span> <span class="n">somg12</span>
      <span class="n">calp2</span> <span class="o">=</span> <span class="n">sbet12</span> <span class="o">-</span> <span class="n">cbet1</span> <span class="o">*</span> <span class="n">sbet2</span> <span class="o">*</span> <span class="p">(</span><span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="n">somg12</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">comg12</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">comg12</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">comg12</span><span class="p">)</span>
      <span class="n">salp2</span><span class="p">,</span> <span class="n">calp2</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">salp2</span><span class="p">,</span> <span class="n">calp2</span><span class="p">)</span>
      <span class="c1"># Set return value</span>
      <span class="n">sig12</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">ssig12</span><span class="p">,</span> <span class="n">csig12</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">0.1</span> <span class="ow">or</span> <span class="c1"># Skip astroid calc if too eccentric</span>
          <span class="n">csig12</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">or</span>
          <span class="n">ssig12</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="n">cbet1</span><span class="p">)):</span>
      <span class="c1"># Nothing to do, zeroth order spherical approximation is OK</span>
      <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># Scale lam12 and bet2 to x, y coordinate system where antipodal point</span>
      <span class="c1"># is at origin and singular point is at y = 0, x = -1.</span>
      <span class="c1"># real y, lamscale, betscale</span>
      <span class="c1"># Volatile declaration needed to fix inverse case</span>
      <span class="c1"># 56.320923501171 0 -56.320923501171 179.664747671772880215</span>
      <span class="c1"># which otherwise fails with g++ 4.4.4 x86 -O3</span>
      <span class="c1"># volatile real x</span>
      <span class="n">lam12x</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="o">-</span><span class="n">slam12</span><span class="p">,</span> <span class="o">-</span><span class="n">clam12</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>            <span class="c1"># In fact f == 0 does not get here</span>
        <span class="c1"># x = dlong, y = dlat</span>
        <span class="n">k2</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="n">sbet1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ep2</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">k2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">k2</span><span class="p">))</span> <span class="o">+</span> <span class="n">k2</span><span class="p">)</span>
        <span class="n">lamscale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">*</span> <span class="n">cbet1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_A3f</span><span class="p">(</span><span class="n">eps</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">betscale</span> <span class="o">=</span> <span class="n">lamscale</span> <span class="o">*</span> <span class="n">cbet1</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">lam12x</span> <span class="o">/</span> <span class="n">lamscale</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">sbet12a</span> <span class="o">/</span> <span class="n">betscale</span>
      <span class="k">else</span><span class="p">:</span>                     <span class="c1"># _f &lt; 0</span>
        <span class="c1"># x = dlat, y = dlong</span>
        <span class="n">cbet12a</span> <span class="o">=</span> <span class="n">cbet2</span> <span class="o">*</span> <span class="n">cbet1</span> <span class="o">-</span> <span class="n">sbet2</span> <span class="o">*</span> <span class="n">sbet1</span>
        <span class="n">bet12a</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">sbet12a</span><span class="p">,</span> <span class="n">cbet12a</span><span class="p">)</span>
        <span class="c1"># real m12b, m0, dummy</span>
        <span class="c1"># In the case of lon12 = 180, this repeats a calculation made in</span>
        <span class="c1"># Inverse.</span>
        <span class="n">dummy</span><span class="p">,</span> <span class="n">m12b</span><span class="p">,</span> <span class="n">m0</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Lengths</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_n</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="n">bet12a</span><span class="p">,</span> <span class="n">sbet1</span><span class="p">,</span> <span class="o">-</span><span class="n">cbet1</span><span class="p">,</span> <span class="n">dn1</span><span class="p">,</span> <span class="n">sbet2</span><span class="p">,</span> <span class="n">cbet2</span><span class="p">,</span> <span class="n">dn2</span><span class="p">,</span>
          <span class="n">cbet1</span><span class="p">,</span> <span class="n">cbet2</span><span class="p">,</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">REDUCEDLENGTH</span><span class="p">,</span> <span class="n">C1a</span><span class="p">,</span> <span class="n">C2a</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">m12b</span> <span class="o">/</span> <span class="p">(</span><span class="n">cbet1</span> <span class="o">*</span> <span class="n">cbet2</span> <span class="o">*</span> <span class="n">m0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">betscale</span> <span class="o">=</span> <span class="p">(</span><span class="n">sbet12a</span> <span class="o">/</span> <span class="n">x</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.01</span>
                    <span class="k">else</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="n">cbet1</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">lamscale</span> <span class="o">=</span> <span class="n">betscale</span> <span class="o">/</span> <span class="n">cbet1</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">lam12x</span> <span class="o">/</span> <span class="n">lamscale</span>

      <span class="k">if</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">tol1_</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">xthresh_</span><span class="p">:</span>
        <span class="c1"># strip near cut</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
          <span class="n">salp1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="n">x</span><span class="p">);</span> <span class="n">calp1</span> <span class="o">=</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="n">salp1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">calp1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="mf">0.0</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">tol1_</span> <span class="k">else</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">),</span> <span class="n">x</span><span class="p">)</span>
          <span class="n">salp1</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="n">calp1</span><span class="p">))</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Estimate alp1, by solving the astroid problem.</span>
        <span class="c1">#</span>
        <span class="c1"># Could estimate alpha1 = theta + pi/2, directly, i.e.,</span>
        <span class="c1">#   calp1 = y/k; salp1 = -x/(1+k);  for _f &gt;= 0</span>
        <span class="c1">#   calp1 = x/(1+k); salp1 = -y/k;  for _f &lt; 0 (need to check)</span>
        <span class="c1">#</span>
        <span class="c1"># However, it&#39;s better to estimate omg12 from astroid and use</span>
        <span class="c1"># spherical formula to compute alp1.  This reduces the mean number of</span>
        <span class="c1"># Newton iterations for astroid cases from 2.24 (min 0, max 6) to 2.12</span>
        <span class="c1"># (min 0 max 5).  The changes in the number of iterations are as</span>
        <span class="c1"># follows:</span>
        <span class="c1">#</span>
        <span class="c1"># change percent</span>
        <span class="c1">#    1       5</span>
        <span class="c1">#    0      78</span>
        <span class="c1">#   -1      16</span>
        <span class="c1">#   -2       0.6</span>
        <span class="c1">#   -3       0.04</span>
        <span class="c1">#   -4       0.002</span>
        <span class="c1">#</span>
        <span class="c1"># The histogram of iterations is (m = number of iterations estimating</span>
        <span class="c1"># alp1 directly, n = number of iterations estimating via omg12, total</span>
        <span class="c1"># number of trials = 148605):</span>
        <span class="c1">#</span>
        <span class="c1">#  iter    m      n</span>
        <span class="c1">#    0   148    186</span>
        <span class="c1">#    1 13046  13845</span>
        <span class="c1">#    2 93315 102225</span>
        <span class="c1">#    3 36189  32341</span>
        <span class="c1">#    4  5396      7</span>
        <span class="c1">#    5   455      1</span>
        <span class="c1">#    6    56      0</span>
        <span class="c1">#</span>
        <span class="c1"># Because omg12 is near pi, estimate work with omg12a = pi - omg12</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">_Astroid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">omg12a</span> <span class="o">=</span> <span class="n">lamscale</span> <span class="o">*</span> <span class="p">(</span> <span class="o">-</span><span class="n">x</span> <span class="o">*</span> <span class="n">k</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                              <span class="k">else</span> <span class="o">-</span><span class="n">y</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="n">k</span> <span class="p">)</span>
        <span class="n">somg12</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">omg12a</span><span class="p">);</span> <span class="n">comg12</span> <span class="o">=</span> <span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omg12a</span><span class="p">)</span>
        <span class="c1"># Update spherical estimate of alp1 using omg12 instead of lam12</span>
        <span class="n">salp1</span> <span class="o">=</span> <span class="n">cbet2</span> <span class="o">*</span> <span class="n">somg12</span>
        <span class="n">calp1</span> <span class="o">=</span> <span class="n">sbet12a</span> <span class="o">-</span> <span class="n">cbet2</span> <span class="o">*</span> <span class="n">sbet1</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="n">somg12</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">comg12</span><span class="p">)</span>
    <span class="c1"># Sanity check on starting guess.  Backwards check allows NaN through.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">salp1</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
      <span class="n">salp1</span><span class="p">,</span> <span class="n">calp1</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">salp1</span><span class="p">,</span> <span class="n">calp1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">salp1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">calp1</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">sig12</span><span class="p">,</span> <span class="n">salp1</span><span class="p">,</span> <span class="n">calp1</span><span class="p">,</span> <span class="n">salp2</span><span class="p">,</span> <span class="n">calp2</span><span class="p">,</span> <span class="n">dnm</span>

  <span class="c1"># return lam12, salp2, calp2, sig12, ssig1, csig1, ssig2, csig2, eps,</span>
  <span class="c1"># domg12, dlam12</span>
  <span class="k">def</span> <span class="nf">_Lambda12</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sbet1</span><span class="p">,</span> <span class="n">cbet1</span><span class="p">,</span> <span class="n">dn1</span><span class="p">,</span> <span class="n">sbet2</span><span class="p">,</span> <span class="n">cbet2</span><span class="p">,</span> <span class="n">dn2</span><span class="p">,</span> <span class="n">salp1</span><span class="p">,</span> <span class="n">calp1</span><span class="p">,</span>
                <span class="n">slam120</span><span class="p">,</span> <span class="n">clam120</span><span class="p">,</span> <span class="n">diffp</span><span class="p">,</span>
                <span class="c1"># Scratch areas of the right size</span>
                <span class="n">C1a</span><span class="p">,</span> <span class="n">C2a</span><span class="p">,</span> <span class="n">C3a</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Private: Solve hybrid problem&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sbet1</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">calp1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="c1"># Break degeneracy of equatorial line.  This case has already been</span>
      <span class="c1"># handled.</span>
      <span class="n">calp1</span> <span class="o">=</span> <span class="o">-</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">tiny_</span>

    <span class="c1"># sin(alp1) * cos(bet1) = sin(alp0)</span>
    <span class="n">salp0</span> <span class="o">=</span> <span class="n">salp1</span> <span class="o">*</span> <span class="n">cbet1</span>
    <span class="n">calp0</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">calp1</span><span class="p">,</span> <span class="n">salp1</span> <span class="o">*</span> <span class="n">sbet1</span><span class="p">)</span> <span class="c1"># calp0 &gt; 0</span>

    <span class="c1"># real somg1, comg1, somg2, comg2, lam12</span>
    <span class="c1"># tan(bet1) = tan(sig1) * cos(alp1)</span>
    <span class="c1"># tan(omg1) = sin(alp0) * tan(sig1) = tan(omg1)=tan(alp1)*sin(bet1)</span>
    <span class="n">ssig1</span> <span class="o">=</span> <span class="n">sbet1</span><span class="p">;</span> <span class="n">somg1</span> <span class="o">=</span> <span class="n">salp0</span> <span class="o">*</span> <span class="n">sbet1</span>
    <span class="n">csig1</span> <span class="o">=</span> <span class="n">comg1</span> <span class="o">=</span> <span class="n">calp1</span> <span class="o">*</span> <span class="n">cbet1</span>
    <span class="n">ssig1</span><span class="p">,</span> <span class="n">csig1</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ssig1</span><span class="p">,</span> <span class="n">csig1</span><span class="p">)</span>
    <span class="c1"># Math.norm(somg1, comg1); -- don&#39;t need to normalize!</span>

    <span class="c1"># Enforce symmetries in the case abs(bet2) = -bet1.  Need to be careful</span>
    <span class="c1"># about this case, since this can yield singularities in the Newton</span>
    <span class="c1"># iteration.</span>
    <span class="c1"># sin(alp2) * cos(bet2) = sin(alp0)</span>
    <span class="n">salp2</span> <span class="o">=</span> <span class="n">salp0</span> <span class="o">/</span> <span class="n">cbet2</span> <span class="k">if</span> <span class="n">cbet2</span> <span class="o">!=</span> <span class="n">cbet1</span> <span class="k">else</span> <span class="n">salp1</span>
    <span class="c1"># calp2 = sqrt(1 - sq(salp2))</span>
    <span class="c1">#       = sqrt(sq(calp0) - sq(sbet2)) / cbet2</span>
    <span class="c1"># and subst for calp0 and rearrange to give (choose positive sqrt</span>
    <span class="c1"># to give alp2 in [0, pi/2]).</span>
    <span class="n">calp2</span> <span class="o">=</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="n">calp1</span> <span class="o">*</span> <span class="n">cbet1</span><span class="p">)</span> <span class="o">+</span>
                       <span class="p">((</span><span class="n">cbet2</span> <span class="o">-</span> <span class="n">cbet1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">cbet1</span> <span class="o">+</span> <span class="n">cbet2</span><span class="p">)</span> <span class="k">if</span> <span class="n">cbet1</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">sbet1</span>
                        <span class="k">else</span> <span class="p">(</span><span class="n">sbet1</span> <span class="o">-</span> <span class="n">sbet2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">sbet1</span> <span class="o">+</span> <span class="n">sbet2</span><span class="p">)))</span> <span class="o">/</span> <span class="n">cbet2</span>
             <span class="k">if</span> <span class="n">cbet2</span> <span class="o">!=</span> <span class="n">cbet1</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">sbet2</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="n">sbet1</span> <span class="k">else</span> <span class="nb">abs</span><span class="p">(</span><span class="n">calp1</span><span class="p">))</span>
    <span class="c1"># tan(bet2) = tan(sig2) * cos(alp2)</span>
    <span class="c1"># tan(omg2) = sin(alp0) * tan(sig2).</span>
    <span class="n">ssig2</span> <span class="o">=</span> <span class="n">sbet2</span><span class="p">;</span> <span class="n">somg2</span> <span class="o">=</span> <span class="n">salp0</span> <span class="o">*</span> <span class="n">sbet2</span>
    <span class="n">csig2</span> <span class="o">=</span> <span class="n">comg2</span> <span class="o">=</span> <span class="n">calp2</span> <span class="o">*</span> <span class="n">cbet2</span>
    <span class="n">ssig2</span><span class="p">,</span> <span class="n">csig2</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ssig2</span><span class="p">,</span> <span class="n">csig2</span><span class="p">)</span>
    <span class="c1"># Math.norm(somg2, comg2); -- don&#39;t need to normalize!</span>

    <span class="c1"># sig12 = sig2 - sig1, limit to [0, pi]</span>
    <span class="n">sig12</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">csig1</span> <span class="o">*</span> <span class="n">ssig2</span> <span class="o">-</span> <span class="n">ssig1</span> <span class="o">*</span> <span class="n">csig2</span><span class="p">),</span>
                                <span class="n">csig1</span> <span class="o">*</span> <span class="n">csig2</span> <span class="o">+</span> <span class="n">ssig1</span> <span class="o">*</span> <span class="n">ssig2</span><span class="p">)</span>

    <span class="c1"># omg12 = omg2 - omg1, limit to [0, pi]</span>
    <span class="n">somg12</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">comg1</span> <span class="o">*</span> <span class="n">somg2</span> <span class="o">-</span> <span class="n">somg1</span> <span class="o">*</span> <span class="n">comg2</span><span class="p">)</span>
    <span class="n">comg12</span> <span class="o">=</span>          <span class="n">comg1</span> <span class="o">*</span> <span class="n">comg2</span> <span class="o">+</span> <span class="n">somg1</span> <span class="o">*</span> <span class="n">somg2</span>
    <span class="c1"># eta = omg12 - lam120</span>
    <span class="n">eta</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">somg12</span> <span class="o">*</span> <span class="n">clam120</span> <span class="o">-</span> <span class="n">comg12</span> <span class="o">*</span> <span class="n">slam120</span><span class="p">,</span>
                     <span class="n">comg12</span> <span class="o">*</span> <span class="n">clam120</span> <span class="o">+</span> <span class="n">somg12</span> <span class="o">*</span> <span class="n">slam120</span><span class="p">)</span>

    <span class="c1"># real B312</span>
    <span class="n">k2</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="n">calp0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ep2</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="n">k2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">k2</span><span class="p">))</span> <span class="o">+</span> <span class="n">k2</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_C3f</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="n">C3a</span><span class="p">)</span>
    <span class="n">B312</span> <span class="o">=</span> <span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">_SinCosSeries</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">ssig2</span><span class="p">,</span> <span class="n">csig2</span><span class="p">,</span> <span class="n">C3a</span><span class="p">)</span> <span class="o">-</span>
            <span class="n">Geodesic</span><span class="o">.</span><span class="n">_SinCosSeries</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">ssig1</span><span class="p">,</span> <span class="n">csig1</span><span class="p">,</span> <span class="n">C3a</span><span class="p">))</span>
    <span class="n">domg12</span> <span class="o">=</span>  <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_A3f</span><span class="p">(</span><span class="n">eps</span><span class="p">)</span> <span class="o">*</span> <span class="n">salp0</span> <span class="o">*</span> <span class="p">(</span><span class="n">sig12</span> <span class="o">+</span> <span class="n">B312</span><span class="p">)</span>
    <span class="n">lam12</span> <span class="o">=</span> <span class="n">eta</span> <span class="o">+</span> <span class="n">domg12</span>

    <span class="k">if</span> <span class="n">diffp</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">calp2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">dlam12</span> <span class="o">=</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f1</span> <span class="o">*</span> <span class="n">dn1</span> <span class="o">/</span> <span class="n">sbet1</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">dummy</span><span class="p">,</span> <span class="n">dlam12</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Lengths</span><span class="p">(</span>
          <span class="n">eps</span><span class="p">,</span> <span class="n">sig12</span><span class="p">,</span> <span class="n">ssig1</span><span class="p">,</span> <span class="n">csig1</span><span class="p">,</span> <span class="n">dn1</span><span class="p">,</span> <span class="n">ssig2</span><span class="p">,</span> <span class="n">csig2</span><span class="p">,</span> <span class="n">dn2</span><span class="p">,</span> <span class="n">cbet1</span><span class="p">,</span> <span class="n">cbet2</span><span class="p">,</span>
          <span class="n">Geodesic</span><span class="o">.</span><span class="n">REDUCEDLENGTH</span><span class="p">,</span> <span class="n">C1a</span><span class="p">,</span> <span class="n">C2a</span><span class="p">)</span>
        <span class="n">dlam12</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f1</span> <span class="o">/</span> <span class="p">(</span><span class="n">calp2</span> <span class="o">*</span> <span class="n">cbet2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">dlam12</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">lam12</span><span class="p">,</span> <span class="n">salp2</span><span class="p">,</span> <span class="n">calp2</span><span class="p">,</span> <span class="n">sig12</span><span class="p">,</span> <span class="n">ssig1</span><span class="p">,</span> <span class="n">csig1</span><span class="p">,</span> <span class="n">ssig2</span><span class="p">,</span> <span class="n">csig2</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span>
            <span class="n">domg12</span><span class="p">,</span> <span class="n">dlam12</span><span class="p">)</span>

  <span class="c1"># return a12, s12, salp1, calp1, salp2, calp2, m12, M12, M21, S12</span>
  <span class="k">def</span> <span class="nf">_GenInverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span><span class="p">,</span> <span class="n">outmask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Private: General version of the inverse problem&quot;&quot;&quot;</span>
    <span class="n">a12</span> <span class="o">=</span> <span class="n">s12</span> <span class="o">=</span> <span class="n">m12</span> <span class="o">=</span> <span class="n">M12</span> <span class="o">=</span> <span class="n">M21</span> <span class="o">=</span> <span class="n">S12</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">nan</span> <span class="c1"># return vals</span>

    <span class="n">outmask</span> <span class="o">&amp;=</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">OUT_MASK</span>
    <span class="c1"># Compute longitude difference (AngDiff does this carefully).  Result is</span>
    <span class="c1"># in [-180, 180] but -180 is only for west-going geodesics.  180 is for</span>
    <span class="c1"># east-going and meridional geodesics.</span>
    <span class="n">lon12</span><span class="p">,</span> <span class="n">lon12s</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">AngDiff</span><span class="p">(</span><span class="n">lon1</span><span class="p">,</span> <span class="n">lon2</span><span class="p">)</span>
    <span class="c1"># Make longitude difference positive.</span>
    <span class="n">lonsign</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">lon12</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
    <span class="c1"># If very close to being on the same half-meridian, then make it so.</span>
    <span class="n">lon12</span> <span class="o">=</span> <span class="n">lonsign</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="n">AngRound</span><span class="p">(</span><span class="n">lon12</span><span class="p">)</span>
    <span class="n">lon12s</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">AngRound</span><span class="p">((</span><span class="mi">180</span> <span class="o">-</span> <span class="n">lon12</span><span class="p">)</span> <span class="o">-</span> <span class="n">lonsign</span> <span class="o">*</span> <span class="n">lon12s</span><span class="p">)</span>
    <span class="n">lam12</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lon12</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lon12</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
      <span class="n">slam12</span><span class="p">,</span> <span class="n">clam12</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">sincosd</span><span class="p">(</span><span class="n">lon12s</span><span class="p">);</span> <span class="n">clam12</span> <span class="o">=</span> <span class="o">-</span><span class="n">clam12</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">slam12</span><span class="p">,</span> <span class="n">clam12</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">sincosd</span><span class="p">(</span><span class="n">lon12</span><span class="p">)</span>

    <span class="c1"># If really close to the equator, treat as on equator.</span>
    <span class="n">lat1</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">AngRound</span><span class="p">(</span><span class="n">Math</span><span class="o">.</span><span class="n">LatFix</span><span class="p">(</span><span class="n">lat1</span><span class="p">))</span>
    <span class="n">lat2</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">AngRound</span><span class="p">(</span><span class="n">Math</span><span class="o">.</span><span class="n">LatFix</span><span class="p">(</span><span class="n">lat2</span><span class="p">))</span>
    <span class="c1"># Swap points so that point with higher (abs) latitude is point 1</span>
    <span class="c1"># If one latitude is a nan, then it becomes lat1.</span>
    <span class="n">swapp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">swapp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">lonsign</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
      <span class="n">lat2</span><span class="p">,</span> <span class="n">lat1</span> <span class="o">=</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lat2</span>
    <span class="c1"># Make lat1 &lt;= 0</span>
    <span class="n">latsign</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">lat1</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">lat1</span> <span class="o">*=</span> <span class="n">latsign</span>
    <span class="n">lat2</span> <span class="o">*=</span> <span class="n">latsign</span>
    <span class="c1"># Now we have</span>
    <span class="c1">#</span>
    <span class="c1">#     0 &lt;= lon12 &lt;= 180</span>
    <span class="c1">#     -90 &lt;= lat1 &lt;= 0</span>
    <span class="c1">#     lat1 &lt;= lat2 &lt;= -lat1</span>
    <span class="c1">#</span>
    <span class="c1"># longsign, swapp, latsign register the transformation to bring the</span>
    <span class="c1"># coordinates to this canonical form.  In all cases, 1 means no change was</span>
    <span class="c1"># made.  We make these transformations so that there are few cases to</span>
    <span class="c1"># check, e.g., on verifying quadrants in atan2.  In addition, this</span>
    <span class="c1"># enforces some symmetries in the results returned.</span>

    <span class="c1"># real phi, sbet1, cbet1, sbet2, cbet2, s12x, m12x</span>

    <span class="n">sbet1</span><span class="p">,</span> <span class="n">cbet1</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">sincosd</span><span class="p">(</span><span class="n">lat1</span><span class="p">);</span> <span class="n">sbet1</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f1</span>
    <span class="c1"># Ensure cbet1 = +epsilon at poles</span>
    <span class="n">sbet1</span><span class="p">,</span> <span class="n">cbet1</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">sbet1</span><span class="p">,</span> <span class="n">cbet1</span><span class="p">);</span> <span class="n">cbet1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">tiny_</span><span class="p">,</span> <span class="n">cbet1</span><span class="p">)</span>

    <span class="n">sbet2</span><span class="p">,</span> <span class="n">cbet2</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">sincosd</span><span class="p">(</span><span class="n">lat2</span><span class="p">);</span> <span class="n">sbet2</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f1</span>
    <span class="c1"># Ensure cbet2 = +epsilon at poles</span>
    <span class="n">sbet2</span><span class="p">,</span> <span class="n">cbet2</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">sbet2</span><span class="p">,</span> <span class="n">cbet2</span><span class="p">);</span> <span class="n">cbet2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">tiny_</span><span class="p">,</span> <span class="n">cbet2</span><span class="p">)</span>

    <span class="c1"># If cbet1 &lt; -sbet1, then cbet2 - cbet1 is a sensitive measure of the</span>
    <span class="c1"># |bet1| - |bet2|.  Alternatively (cbet1 &gt;= -sbet1), abs(sbet2) + sbet1 is</span>
    <span class="c1"># a better measure.  This logic is used in assigning calp2 in Lambda12.</span>
    <span class="c1"># Sometimes these quantities vanish and in that case we force bet2 = +/-</span>
    <span class="c1"># bet1 exactly.  An example where is is necessary is the inverse problem</span>
    <span class="c1"># 48.522876735459 0 -48.52287673545898293 179.599720456223079643</span>
    <span class="c1"># which failed with Visual Studio 10 (Release and Debug)</span>

    <span class="k">if</span> <span class="n">cbet1</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">sbet1</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">cbet2</span> <span class="o">==</span> <span class="n">cbet1</span><span class="p">:</span>
        <span class="n">sbet2</span> <span class="o">=</span> <span class="n">sbet1</span> <span class="k">if</span> <span class="n">sbet2</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="n">sbet1</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">sbet2</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">sbet1</span><span class="p">:</span>
        <span class="n">cbet2</span> <span class="o">=</span> <span class="n">cbet1</span>

    <span class="n">dn1</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ep2</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="n">sbet1</span><span class="p">))</span>
    <span class="n">dn2</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ep2</span> <span class="o">*</span> <span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="n">sbet2</span><span class="p">))</span>

    <span class="c1"># real a12, sig12, calp1, salp1, calp2, salp2</span>
    <span class="c1"># index zero elements of these arrays are unused</span>
    <span class="n">C1a</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">nC1_</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">C2a</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">nC2_</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">C3a</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">nC3_</span><span class="p">))</span>

    <span class="n">meridian</span> <span class="o">=</span> <span class="n">lat1</span> <span class="o">==</span> <span class="o">-</span><span class="mi">90</span> <span class="ow">or</span> <span class="n">slam12</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">meridian</span><span class="p">:</span>

      <span class="c1"># Endpoints are on a single full meridian, so the geodesic might lie on</span>
      <span class="c1"># a meridian.</span>

      <span class="n">calp1</span> <span class="o">=</span> <span class="n">clam12</span><span class="p">;</span> <span class="n">salp1</span> <span class="o">=</span> <span class="n">slam12</span> <span class="c1"># Head to the target longitude</span>
      <span class="n">calp2</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span> <span class="n">salp2</span> <span class="o">=</span> <span class="mf">0.0</span>       <span class="c1"># At the target we&#39;re heading north</span>

      <span class="c1"># tan(bet) = tan(sig) * cos(alp)</span>
      <span class="n">ssig1</span> <span class="o">=</span> <span class="n">sbet1</span><span class="p">;</span> <span class="n">csig1</span> <span class="o">=</span> <span class="n">calp1</span> <span class="o">*</span> <span class="n">cbet1</span>
      <span class="n">ssig2</span> <span class="o">=</span> <span class="n">sbet2</span><span class="p">;</span> <span class="n">csig2</span> <span class="o">=</span> <span class="n">calp2</span> <span class="o">*</span> <span class="n">cbet2</span>

      <span class="c1"># sig12 = sig2 - sig1</span>
      <span class="n">sig12</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">csig1</span> <span class="o">*</span> <span class="n">ssig2</span> <span class="o">-</span> <span class="n">ssig1</span> <span class="o">*</span> <span class="n">csig2</span><span class="p">),</span>
                                  <span class="n">csig1</span> <span class="o">*</span> <span class="n">csig2</span> <span class="o">+</span> <span class="n">ssig1</span> <span class="o">*</span> <span class="n">ssig2</span><span class="p">)</span>

      <span class="n">s12x</span><span class="p">,</span> <span class="n">m12x</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">M12</span><span class="p">,</span> <span class="n">M21</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Lengths</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n</span><span class="p">,</span> <span class="n">sig12</span><span class="p">,</span> <span class="n">ssig1</span><span class="p">,</span> <span class="n">csig1</span><span class="p">,</span> <span class="n">dn1</span><span class="p">,</span> <span class="n">ssig2</span><span class="p">,</span> <span class="n">csig2</span><span class="p">,</span> <span class="n">dn2</span><span class="p">,</span> <span class="n">cbet1</span><span class="p">,</span> <span class="n">cbet2</span><span class="p">,</span>
        <span class="n">outmask</span> <span class="o">|</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">DISTANCE</span> <span class="o">|</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">REDUCEDLENGTH</span><span class="p">,</span> <span class="n">C1a</span><span class="p">,</span> <span class="n">C2a</span><span class="p">)</span>

      <span class="c1"># Add the check for sig12 since zero length geodesics might yield m12 &lt;</span>
      <span class="c1"># 0.  Test case was</span>
      <span class="c1">#</span>
      <span class="c1">#    echo 20.001 0 20.001 0 | GeodSolve -i</span>
      <span class="c1">#</span>
      <span class="c1"># In fact, we will have sig12 &gt; pi/2 for meridional geodesic which is</span>
      <span class="c1"># not a shortest path.</span>
      <span class="k">if</span> <span class="n">sig12</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">m12x</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sig12</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">tiny_</span><span class="p">:</span>
          <span class="n">sig12</span> <span class="o">=</span> <span class="n">m12x</span> <span class="o">=</span> <span class="n">s12x</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">m12x</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span>
        <span class="n">s12x</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span>
        <span class="n">a12</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">sig12</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="c1"># m12 &lt; 0, i.e., prolate and too close to anti-podal</span>
        <span class="n">meridian</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># end if meridian:</span>

    <span class="c1"># somg12 &gt; 1 marks that it needs to be calculated</span>
    <span class="n">somg12</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">;</span> <span class="n">comg12</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span> <span class="n">omg12</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">meridian</span> <span class="ow">and</span>
        <span class="n">sbet1</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span>   <span class="c1"># and sbet2 == 0</span>
        <span class="c1"># Mimic the way Lambda12 works with calp1 = 0</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">lon12s</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">*</span> <span class="mi">180</span><span class="p">)):</span>

      <span class="c1"># Geodesic runs along equator</span>
      <span class="n">calp1</span> <span class="o">=</span> <span class="n">calp2</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span> <span class="n">salp1</span> <span class="o">=</span> <span class="n">salp2</span> <span class="o">=</span> <span class="mf">1.0</span>
      <span class="n">s12x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">*</span> <span class="n">lam12</span>
      <span class="n">sig12</span> <span class="o">=</span> <span class="n">omg12</span> <span class="o">=</span> <span class="n">lam12</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f1</span>
      <span class="n">m12x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">sig12</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">GEODESICSCALE</span><span class="p">:</span>
        <span class="n">M12</span> <span class="o">=</span> <span class="n">M21</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">sig12</span><span class="p">)</span>
      <span class="n">a12</span> <span class="o">=</span> <span class="n">lon12</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_f1</span>

    <span class="k">elif</span> <span class="ow">not</span> <span class="n">meridian</span><span class="p">:</span>

      <span class="c1"># Now point1 and point2 belong within a hemisphere bounded by a</span>
      <span class="c1"># meridian and geodesic is neither meridional or equatorial.</span>

      <span class="c1"># Figure a starting point for Newton&#39;s method</span>
      <span class="n">sig12</span><span class="p">,</span> <span class="n">salp1</span><span class="p">,</span> <span class="n">calp1</span><span class="p">,</span> <span class="n">salp2</span><span class="p">,</span> <span class="n">calp2</span><span class="p">,</span> <span class="n">dnm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_InverseStart</span><span class="p">(</span>
        <span class="n">sbet1</span><span class="p">,</span> <span class="n">cbet1</span><span class="p">,</span> <span class="n">dn1</span><span class="p">,</span> <span class="n">sbet2</span><span class="p">,</span> <span class="n">cbet2</span><span class="p">,</span> <span class="n">dn2</span><span class="p">,</span> <span class="n">lam12</span><span class="p">,</span> <span class="n">slam12</span><span class="p">,</span> <span class="n">clam12</span><span class="p">,</span> <span class="n">C1a</span><span class="p">,</span> <span class="n">C2a</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">sig12</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Short lines (InverseStart sets salp2, calp2, dnm)</span>
        <span class="n">s12x</span> <span class="o">=</span> <span class="n">sig12</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="o">*</span> <span class="n">dnm</span>
        <span class="n">m12x</span> <span class="o">=</span> <span class="p">(</span><span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="n">dnm</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">sig12</span> <span class="o">/</span> <span class="n">dnm</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">GEODESICSCALE</span><span class="p">:</span>
          <span class="n">M12</span> <span class="o">=</span> <span class="n">M21</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">sig12</span> <span class="o">/</span> <span class="n">dnm</span><span class="p">)</span>
        <span class="n">a12</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">sig12</span><span class="p">)</span>
        <span class="n">omg12</span> <span class="o">=</span> <span class="n">lam12</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_f1</span> <span class="o">*</span> <span class="n">dnm</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>

        <span class="c1"># Newton&#39;s method.  This is a straightforward solution of f(alp1) =</span>
        <span class="c1"># lambda12(alp1) - lam12 = 0 with one wrinkle.  f(alp) has exactly one</span>
        <span class="c1"># root in the interval (0, pi) and its derivative is positive at the</span>
        <span class="c1"># root.  Thus f(alp) is positive for alp &gt; alp1 and negative for alp &lt;</span>
        <span class="c1"># alp1.  During the course of the iteration, a range (alp1a, alp1b) is</span>
        <span class="c1"># maintained which brackets the root and with each evaluation of f(alp)</span>
        <span class="c1"># the range is shrunk if possible.  Newton&#39;s method is restarted</span>
        <span class="c1"># whenever the derivative of f is negative (because the new value of</span>
        <span class="c1"># alp1 is then further from the solution) or if the new estimate of</span>
        <span class="c1"># alp1 lies outside (0,pi); in this case, the new starting guess is</span>
        <span class="c1"># taken to be (alp1a + alp1b) / 2.</span>
        <span class="c1"># real ssig1, csig1, ssig2, csig2, eps</span>
        <span class="n">numit</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">tripn</span> <span class="o">=</span> <span class="n">tripb</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Bracketing range</span>
        <span class="n">salp1a</span> <span class="o">=</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">tiny_</span><span class="p">;</span> <span class="n">calp1a</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">salp1b</span> <span class="o">=</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">tiny_</span><span class="p">;</span> <span class="n">calp1b</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

        <span class="k">while</span> <span class="n">numit</span> <span class="o">&lt;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">maxit2_</span><span class="p">:</span>
          <span class="c1"># the WGS84 test set: mean = 1.47, sd = 1.25, max = 16</span>
          <span class="c1"># WGS84 and random input: mean = 2.85, sd = 0.60</span>
          <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">salp2</span><span class="p">,</span> <span class="n">calp2</span><span class="p">,</span> <span class="n">sig12</span><span class="p">,</span> <span class="n">ssig1</span><span class="p">,</span> <span class="n">csig1</span><span class="p">,</span> <span class="n">ssig2</span><span class="p">,</span> <span class="n">csig2</span><span class="p">,</span>
           <span class="n">eps</span><span class="p">,</span> <span class="n">domg12</span><span class="p">,</span> <span class="n">dv</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Lambda12</span><span class="p">(</span>
             <span class="n">sbet1</span><span class="p">,</span> <span class="n">cbet1</span><span class="p">,</span> <span class="n">dn1</span><span class="p">,</span> <span class="n">sbet2</span><span class="p">,</span> <span class="n">cbet2</span><span class="p">,</span> <span class="n">dn2</span><span class="p">,</span>
             <span class="n">salp1</span><span class="p">,</span> <span class="n">calp1</span><span class="p">,</span> <span class="n">slam12</span><span class="p">,</span> <span class="n">clam12</span><span class="p">,</span> <span class="n">numit</span> <span class="o">&lt;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">maxit1_</span><span class="p">,</span>
             <span class="n">C1a</span><span class="p">,</span> <span class="n">C2a</span><span class="p">,</span> <span class="n">C3a</span><span class="p">)</span>
          <span class="c1"># 2 * tol0 is approximately 1 ulp for a number in [0, pi].</span>
          <span class="c1"># Reversed test to allow escape with NaNs</span>
          <span class="k">if</span> <span class="n">tripb</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">8</span> <span class="k">if</span> <span class="n">tripn</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">tol0_</span><span class="p">):</span>
            <span class="k">break</span>
          <span class="c1"># Update bracketing values</span>
          <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">numit</span> <span class="o">&gt;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">maxit1_</span> <span class="ow">or</span>
                        <span class="n">calp1</span><span class="o">/</span><span class="n">salp1</span> <span class="o">&gt;</span> <span class="n">calp1b</span><span class="o">/</span><span class="n">salp1b</span><span class="p">):</span>
            <span class="n">salp1b</span> <span class="o">=</span> <span class="n">salp1</span><span class="p">;</span> <span class="n">calp1b</span> <span class="o">=</span> <span class="n">calp1</span>
          <span class="k">elif</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">numit</span> <span class="o">&gt;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">maxit1_</span> <span class="ow">or</span>
                          <span class="n">calp1</span><span class="o">/</span><span class="n">salp1</span> <span class="o">&lt;</span> <span class="n">calp1a</span><span class="o">/</span><span class="n">salp1a</span><span class="p">):</span>
            <span class="n">salp1a</span> <span class="o">=</span> <span class="n">salp1</span><span class="p">;</span> <span class="n">calp1a</span> <span class="o">=</span> <span class="n">calp1</span>

          <span class="n">numit</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="k">if</span> <span class="n">numit</span> <span class="o">&lt;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">maxit1_</span> <span class="ow">and</span> <span class="n">dv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dalp1</span> <span class="o">=</span> <span class="o">-</span><span class="n">v</span><span class="o">/</span><span class="n">dv</span>
            <span class="n">sdalp1</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dalp1</span><span class="p">);</span> <span class="n">cdalp1</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dalp1</span><span class="p">)</span>
            <span class="n">nsalp1</span> <span class="o">=</span> <span class="n">salp1</span> <span class="o">*</span> <span class="n">cdalp1</span> <span class="o">+</span> <span class="n">calp1</span> <span class="o">*</span> <span class="n">sdalp1</span>
            <span class="k">if</span> <span class="n">nsalp1</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dalp1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
              <span class="n">calp1</span> <span class="o">=</span> <span class="n">calp1</span> <span class="o">*</span> <span class="n">cdalp1</span> <span class="o">-</span> <span class="n">salp1</span> <span class="o">*</span> <span class="n">sdalp1</span>
              <span class="n">salp1</span> <span class="o">=</span> <span class="n">nsalp1</span>
              <span class="n">salp1</span><span class="p">,</span> <span class="n">calp1</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">salp1</span><span class="p">,</span> <span class="n">calp1</span><span class="p">)</span>
              <span class="c1"># In some regimes we don&#39;t get quadratic convergence because</span>
              <span class="c1"># slope -&gt; 0.  So use convergence conditions based on epsilon</span>
              <span class="c1"># instead of sqrt(epsilon).</span>
              <span class="n">tripn</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">tol0_</span>
              <span class="k">continue</span>
          <span class="c1"># Either dv was not positive or updated value was outside</span>
          <span class="c1"># legal range.  Use the midpoint of the bracket as the next</span>
          <span class="c1"># estimate.  This mechanism is not needed for the WGS84</span>
          <span class="c1"># ellipsoid, but it does catch problems with more eccentric</span>
          <span class="c1"># ellipsoids.  Its efficacy is such for</span>
          <span class="c1"># the WGS84 test set with the starting guess set to alp1 = 90deg:</span>
          <span class="c1"># the WGS84 test set: mean = 5.21, sd = 3.93, max = 24</span>
          <span class="c1"># WGS84 and random input: mean = 4.74, sd = 0.99</span>
          <span class="n">salp1</span> <span class="o">=</span> <span class="p">(</span><span class="n">salp1a</span> <span class="o">+</span> <span class="n">salp1b</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
          <span class="n">calp1</span> <span class="o">=</span> <span class="p">(</span><span class="n">calp1a</span> <span class="o">+</span> <span class="n">calp1b</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
          <span class="n">salp1</span><span class="p">,</span> <span class="n">calp1</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">salp1</span><span class="p">,</span> <span class="n">calp1</span><span class="p">)</span>
          <span class="n">tripn</span> <span class="o">=</span> <span class="kc">False</span>
          <span class="n">tripb</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">salp1a</span> <span class="o">-</span> <span class="n">salp1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">calp1a</span> <span class="o">-</span> <span class="n">calp1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">tolb_</span> <span class="ow">or</span>
                   <span class="nb">abs</span><span class="p">(</span><span class="n">salp1</span> <span class="o">-</span> <span class="n">salp1b</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">calp1</span> <span class="o">-</span> <span class="n">calp1b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">tolb_</span><span class="p">)</span>

        <span class="n">lengthmask</span> <span class="o">=</span> <span class="p">(</span><span class="n">outmask</span> <span class="o">|</span>
                      <span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">DISTANCE</span>
                       <span class="k">if</span> <span class="p">(</span><span class="n">outmask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">REDUCEDLENGTH</span> <span class="o">|</span>
                                      <span class="n">Geodesic</span><span class="o">.</span><span class="n">GEODESICSCALE</span><span class="p">))</span>
                       <span class="k">else</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">EMPTY</span><span class="p">))</span>
        <span class="n">s12x</span><span class="p">,</span> <span class="n">m12x</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">M12</span><span class="p">,</span> <span class="n">M21</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Lengths</span><span class="p">(</span>
          <span class="n">eps</span><span class="p">,</span> <span class="n">sig12</span><span class="p">,</span> <span class="n">ssig1</span><span class="p">,</span> <span class="n">csig1</span><span class="p">,</span> <span class="n">dn1</span><span class="p">,</span> <span class="n">ssig2</span><span class="p">,</span> <span class="n">csig2</span><span class="p">,</span> <span class="n">dn2</span><span class="p">,</span> <span class="n">cbet1</span><span class="p">,</span> <span class="n">cbet2</span><span class="p">,</span>
          <span class="n">lengthmask</span><span class="p">,</span> <span class="n">C1a</span><span class="p">,</span> <span class="n">C2a</span><span class="p">)</span>

        <span class="n">m12x</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span>
        <span class="n">s12x</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_b</span>
        <span class="n">a12</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">sig12</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">AREA</span><span class="p">:</span>
          <span class="c1"># omg12 = lam12 - domg12</span>
          <span class="n">sdomg12</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">domg12</span><span class="p">);</span> <span class="n">cdomg12</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">domg12</span><span class="p">)</span>
          <span class="n">somg12</span> <span class="o">=</span> <span class="n">slam12</span> <span class="o">*</span> <span class="n">cdomg12</span> <span class="o">-</span> <span class="n">clam12</span> <span class="o">*</span> <span class="n">sdomg12</span>
          <span class="n">comg12</span> <span class="o">=</span> <span class="n">clam12</span> <span class="o">*</span> <span class="n">cdomg12</span> <span class="o">+</span> <span class="n">slam12</span> <span class="o">*</span> <span class="n">sdomg12</span>

    <span class="c1"># end elif not meridian</span>

    <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">DISTANCE</span><span class="p">:</span>
      <span class="n">s12</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">+</span> <span class="n">s12x</span>          <span class="c1"># Convert -0 to 0</span>

    <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">REDUCEDLENGTH</span><span class="p">:</span>
      <span class="n">m12</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">+</span> <span class="n">m12x</span>          <span class="c1"># Convert -0 to 0</span>

    <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">AREA</span><span class="p">:</span>
      <span class="c1"># From Lambda12: sin(alp1) * cos(bet1) = sin(alp0)</span>
      <span class="n">salp0</span> <span class="o">=</span> <span class="n">salp1</span> <span class="o">*</span> <span class="n">cbet1</span>
      <span class="n">calp0</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">calp1</span><span class="p">,</span> <span class="n">salp1</span> <span class="o">*</span> <span class="n">sbet1</span><span class="p">)</span> <span class="c1"># calp0 &gt; 0</span>
      <span class="c1"># real alp12</span>
      <span class="k">if</span> <span class="n">calp0</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">salp0</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># From Lambda12: tan(bet) = tan(sig) * cos(alp)</span>
        <span class="n">ssig1</span> <span class="o">=</span> <span class="n">sbet1</span><span class="p">;</span> <span class="n">csig1</span> <span class="o">=</span> <span class="n">calp1</span> <span class="o">*</span> <span class="n">cbet1</span>
        <span class="n">ssig2</span> <span class="o">=</span> <span class="n">sbet2</span><span class="p">;</span> <span class="n">csig2</span> <span class="o">=</span> <span class="n">calp2</span> <span class="o">*</span> <span class="n">cbet2</span>
        <span class="n">k2</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="n">calp0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ep2</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">k2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">k2</span><span class="p">))</span> <span class="o">+</span> <span class="n">k2</span><span class="p">)</span>
        <span class="c1"># Multiplier = a^2 * e^2 * cos(alpha0) * sin(alpha0).</span>
        <span class="n">A4</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">sq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">calp0</span> <span class="o">*</span> <span class="n">salp0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_e2</span>
        <span class="n">ssig1</span><span class="p">,</span> <span class="n">csig1</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ssig1</span><span class="p">,</span> <span class="n">csig1</span><span class="p">)</span>
        <span class="n">ssig2</span><span class="p">,</span> <span class="n">csig2</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ssig2</span><span class="p">,</span> <span class="n">csig2</span><span class="p">)</span>
        <span class="n">C4a</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">nC4_</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_C4f</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="n">C4a</span><span class="p">)</span>
        <span class="n">B41</span> <span class="o">=</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">_SinCosSeries</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">ssig1</span><span class="p">,</span> <span class="n">csig1</span><span class="p">,</span> <span class="n">C4a</span><span class="p">)</span>
        <span class="n">B42</span> <span class="o">=</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">_SinCosSeries</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">ssig2</span><span class="p">,</span> <span class="n">csig2</span><span class="p">,</span> <span class="n">C4a</span><span class="p">)</span>
        <span class="n">S12</span> <span class="o">=</span> <span class="n">A4</span> <span class="o">*</span> <span class="p">(</span><span class="n">B42</span> <span class="o">-</span> <span class="n">B41</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Avoid problems with indeterminate sig1, sig2 on equator</span>
        <span class="n">S12</span> <span class="o">=</span> <span class="mf">0.0</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="n">meridian</span> <span class="ow">and</span> <span class="n">somg12</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">somg12</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">omg12</span><span class="p">);</span> <span class="n">comg12</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omg12</span><span class="p">)</span>

      <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">meridian</span> <span class="ow">and</span>
          <span class="c1"># omg12 &lt; 3/4 * pi</span>
          <span class="n">comg12</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">0.7071</span> <span class="ow">and</span>   <span class="c1"># Long difference not too big</span>
          <span class="n">sbet2</span> <span class="o">-</span> <span class="n">sbet1</span> <span class="o">&lt;</span> <span class="mf">1.75</span><span class="p">):</span> <span class="c1"># Lat difference not too big</span>
        <span class="c1"># Use tan(Gamma/2) = tan(omg12/2)</span>
        <span class="c1"># * (tan(bet1/2)+tan(bet2/2))/(1+tan(bet1/2)*tan(bet2/2))</span>
        <span class="c1"># with tan(x/2) = sin(x)/(1+cos(x))</span>
        <span class="n">domg12</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">comg12</span><span class="p">;</span> <span class="n">dbet1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">cbet1</span><span class="p">;</span> <span class="n">dbet2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">cbet2</span>
        <span class="n">alp12</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span> <span class="n">somg12</span> <span class="o">*</span> <span class="p">(</span> <span class="n">sbet1</span> <span class="o">*</span> <span class="n">dbet2</span> <span class="o">+</span> <span class="n">sbet2</span> <span class="o">*</span> <span class="n">dbet1</span> <span class="p">),</span>
                                <span class="n">domg12</span> <span class="o">*</span> <span class="p">(</span> <span class="n">sbet1</span> <span class="o">*</span> <span class="n">sbet2</span> <span class="o">+</span> <span class="n">dbet1</span> <span class="o">*</span> <span class="n">dbet2</span> <span class="p">)</span> <span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="c1"># alp12 = alp2 - alp1, used in atan2 so no need to normalize</span>
        <span class="n">salp12</span> <span class="o">=</span> <span class="n">salp2</span> <span class="o">*</span> <span class="n">calp1</span> <span class="o">-</span> <span class="n">calp2</span> <span class="o">*</span> <span class="n">salp1</span>
        <span class="n">calp12</span> <span class="o">=</span> <span class="n">calp2</span> <span class="o">*</span> <span class="n">calp1</span> <span class="o">+</span> <span class="n">salp2</span> <span class="o">*</span> <span class="n">salp1</span>
        <span class="c1"># The right thing appears to happen if alp1 = +/-180 and alp2 = 0, viz</span>
        <span class="c1"># salp12 = -0 and alp12 = -180.  However this depends on the sign</span>
        <span class="c1"># being attached to 0 correctly.  The following ensures the correct</span>
        <span class="c1"># behavior.</span>
        <span class="k">if</span> <span class="n">salp12</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">calp12</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
          <span class="n">salp12</span> <span class="o">=</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">tiny_</span> <span class="o">*</span> <span class="n">calp1</span>
          <span class="n">calp12</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">alp12</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">salp12</span><span class="p">,</span> <span class="n">calp12</span><span class="p">)</span>
      <span class="n">S12</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c2</span> <span class="o">*</span> <span class="n">alp12</span>
      <span class="n">S12</span> <span class="o">*=</span> <span class="n">swapp</span> <span class="o">*</span> <span class="n">lonsign</span> <span class="o">*</span> <span class="n">latsign</span>
      <span class="c1"># Convert -0 to 0</span>
      <span class="n">S12</span> <span class="o">+=</span> <span class="mf">0.0</span>

    <span class="c1"># Convert calp, salp to azimuth accounting for lonsign, swapp, latsign.</span>
    <span class="k">if</span> <span class="n">swapp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">salp2</span><span class="p">,</span> <span class="n">salp1</span> <span class="o">=</span> <span class="n">salp1</span><span class="p">,</span> <span class="n">salp2</span>
      <span class="n">calp2</span><span class="p">,</span> <span class="n">calp1</span> <span class="o">=</span> <span class="n">calp1</span><span class="p">,</span> <span class="n">calp2</span>
      <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">GEODESICSCALE</span><span class="p">:</span>
        <span class="n">M21</span><span class="p">,</span> <span class="n">M12</span> <span class="o">=</span> <span class="n">M12</span><span class="p">,</span> <span class="n">M21</span>

    <span class="n">salp1</span> <span class="o">*=</span> <span class="n">swapp</span> <span class="o">*</span> <span class="n">lonsign</span><span class="p">;</span> <span class="n">calp1</span> <span class="o">*=</span> <span class="n">swapp</span> <span class="o">*</span> <span class="n">latsign</span>
    <span class="n">salp2</span> <span class="o">*=</span> <span class="n">swapp</span> <span class="o">*</span> <span class="n">lonsign</span><span class="p">;</span> <span class="n">calp2</span> <span class="o">*=</span> <span class="n">swapp</span> <span class="o">*</span> <span class="n">latsign</span>

    <span class="k">return</span> <span class="n">a12</span><span class="p">,</span> <span class="n">s12</span><span class="p">,</span> <span class="n">salp1</span><span class="p">,</span> <span class="n">calp1</span><span class="p">,</span> <span class="n">salp2</span><span class="p">,</span> <span class="n">calp2</span><span class="p">,</span> <span class="n">m12</span><span class="p">,</span> <span class="n">M12</span><span class="p">,</span> <span class="n">M21</span><span class="p">,</span> <span class="n">S12</span>

<div class="viewcode-block" id="Geodesic.Inverse"><a class="viewcode-back" href="../../_generated/network_wrangler.utils.html#network_wrangler.utils.Geodesic.Inverse">[docs]</a>  <span class="k">def</span> <span class="nf">Inverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span><span class="p">,</span>
              <span class="n">outmask</span> <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">STANDARD</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Solve the inverse geodesic problem</span>

<span class="sd">    :param lat1: latitude of the first point in degrees</span>
<span class="sd">    :param lon1: longitude of the first point in degrees</span>
<span class="sd">    :param lat2: latitude of the second point in degrees</span>
<span class="sd">    :param lon2: longitude of the second point in degrees</span>
<span class="sd">    :param outmask: the :ref:`output mask &lt;outmask&gt;`</span>
<span class="sd">    :return: a :ref:`dict`</span>

<span class="sd">    Compute geodesic between (*lat1*, *lon1*) and (*lat2*, *lon2*).</span>
<span class="sd">    The default value of *outmask* is STANDARD, i.e., the *lat1*,</span>
<span class="sd">    *lon1*, *azi1*, *lat2*, *lon2*, *azi2*, *s12*, *a12* entries are</span>
<span class="sd">    returned.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">a12</span><span class="p">,</span> <span class="n">s12</span><span class="p">,</span> <span class="n">salp1</span><span class="p">,</span><span class="n">calp1</span><span class="p">,</span> <span class="n">salp2</span><span class="p">,</span><span class="n">calp2</span><span class="p">,</span> <span class="n">m12</span><span class="p">,</span> <span class="n">M12</span><span class="p">,</span> <span class="n">M21</span><span class="p">,</span> <span class="n">S12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GenInverse</span><span class="p">(</span>
      <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span><span class="p">,</span> <span class="n">outmask</span><span class="p">)</span>
    <span class="n">outmask</span> <span class="o">&amp;=</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">OUT_MASK</span>
    <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">LONG_UNROLL</span><span class="p">:</span>
      <span class="n">lon12</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">AngDiff</span><span class="p">(</span><span class="n">lon1</span><span class="p">,</span> <span class="n">lon2</span><span class="p">)</span>
      <span class="n">lon2</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon1</span> <span class="o">+</span> <span class="n">lon12</span><span class="p">)</span> <span class="o">+</span> <span class="n">e</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">lon2</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">AngNormalize</span><span class="p">(</span><span class="n">lon2</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lat1&#39;</span><span class="p">:</span> <span class="n">Math</span><span class="o">.</span><span class="n">LatFix</span><span class="p">(</span><span class="n">lat1</span><span class="p">),</span>
              <span class="s1">&#39;lon1&#39;</span><span class="p">:</span> <span class="n">lon1</span> <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">LONG_UNROLL</span> <span class="k">else</span>
              <span class="n">Math</span><span class="o">.</span><span class="n">AngNormalize</span><span class="p">(</span><span class="n">lon1</span><span class="p">),</span>
              <span class="s1">&#39;lat2&#39;</span><span class="p">:</span> <span class="n">Math</span><span class="o">.</span><span class="n">LatFix</span><span class="p">(</span><span class="n">lat2</span><span class="p">),</span>
              <span class="s1">&#39;lon2&#39;</span><span class="p">:</span> <span class="n">lon2</span><span class="p">}</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;a12&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a12</span>
    <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">DISTANCE</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;s12&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s12</span>
    <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">AZIMUTH</span><span class="p">:</span>
      <span class="n">result</span><span class="p">[</span><span class="s1">&#39;azi1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">atan2d</span><span class="p">(</span><span class="n">salp1</span><span class="p">,</span> <span class="n">calp1</span><span class="p">)</span>
      <span class="n">result</span><span class="p">[</span><span class="s1">&#39;azi2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">atan2d</span><span class="p">(</span><span class="n">salp2</span><span class="p">,</span> <span class="n">calp2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">REDUCEDLENGTH</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;m12&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m12</span>
    <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">GEODESICSCALE</span><span class="p">:</span>
      <span class="n">result</span><span class="p">[</span><span class="s1">&#39;M12&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">M12</span><span class="p">;</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;M21&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">M21</span>
    <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">AREA</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;S12&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">S12</span>
    <span class="k">return</span> <span class="n">result</span></div>

  <span class="c1"># return a12, lat2, lon2, azi2, s12, m12, M12, M21, S12</span>
  <span class="k">def</span> <span class="nf">_GenDirect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">azi1</span><span class="p">,</span> <span class="n">arcmode</span><span class="p">,</span> <span class="n">s12_a12</span><span class="p">,</span> <span class="n">outmask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Private: General version of direct problem&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">geographiclib.geodesicline</span> <span class="kn">import</span> <span class="n">GeodesicLine</span>
    <span class="c1"># Automatically supply DISTANCE_IN if necessary</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">arcmode</span><span class="p">:</span> <span class="n">outmask</span> <span class="o">|=</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">DISTANCE_IN</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">GeodesicLine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">azi1</span><span class="p">,</span> <span class="n">outmask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">line</span><span class="o">.</span><span class="n">_GenPosition</span><span class="p">(</span><span class="n">arcmode</span><span class="p">,</span> <span class="n">s12_a12</span><span class="p">,</span> <span class="n">outmask</span><span class="p">)</span>

<div class="viewcode-block" id="Geodesic.Direct"><a class="viewcode-back" href="../../_generated/network_wrangler.utils.html#network_wrangler.utils.Geodesic.Direct">[docs]</a>  <span class="k">def</span> <span class="nf">Direct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">azi1</span><span class="p">,</span> <span class="n">s12</span><span class="p">,</span>
             <span class="n">outmask</span> <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">STANDARD</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Solve the direct geodesic problem</span>

<span class="sd">    :param lat1: latitude of the first point in degrees</span>
<span class="sd">    :param lon1: longitude of the first point in degrees</span>
<span class="sd">    :param azi1: azimuth at the first point in degrees</span>
<span class="sd">    :param s12: the distance from the first point to the second in</span>
<span class="sd">      meters</span>
<span class="sd">    :param outmask: the :ref:`output mask &lt;outmask&gt;`</span>
<span class="sd">    :return: a :ref:`dict`</span>

<span class="sd">    Compute geodesic starting at (*lat1*, *lon1*) with azimuth *azi1*</span>
<span class="sd">    and length *s12*.  The default value of *outmask* is STANDARD, i.e.,</span>
<span class="sd">    the *lat1*, *lon1*, *azi1*, *lat2*, *lon2*, *azi2*, *s12*, *a12*</span>
<span class="sd">    entries are returned.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">a12</span><span class="p">,</span> <span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span><span class="p">,</span> <span class="n">azi2</span><span class="p">,</span> <span class="n">s12</span><span class="p">,</span> <span class="n">m12</span><span class="p">,</span> <span class="n">M12</span><span class="p">,</span> <span class="n">M21</span><span class="p">,</span> <span class="n">S12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GenDirect</span><span class="p">(</span>
      <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">azi1</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">s12</span><span class="p">,</span> <span class="n">outmask</span><span class="p">)</span>
    <span class="n">outmask</span> <span class="o">&amp;=</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">OUT_MASK</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lat1&#39;</span><span class="p">:</span> <span class="n">Math</span><span class="o">.</span><span class="n">LatFix</span><span class="p">(</span><span class="n">lat1</span><span class="p">),</span>
              <span class="s1">&#39;lon1&#39;</span><span class="p">:</span> <span class="n">lon1</span> <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">LONG_UNROLL</span> <span class="k">else</span>
              <span class="n">Math</span><span class="o">.</span><span class="n">AngNormalize</span><span class="p">(</span><span class="n">lon1</span><span class="p">),</span>
              <span class="s1">&#39;azi1&#39;</span><span class="p">:</span> <span class="n">Math</span><span class="o">.</span><span class="n">AngNormalize</span><span class="p">(</span><span class="n">azi1</span><span class="p">),</span>
              <span class="s1">&#39;s12&#39;</span><span class="p">:</span> <span class="n">s12</span><span class="p">}</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;a12&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a12</span>
    <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">LATITUDE</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;lat2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat2</span>
    <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">LONGITUDE</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;lon2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lon2</span>
    <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">AZIMUTH</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;azi2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">azi2</span>
    <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">REDUCEDLENGTH</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;m12&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m12</span>
    <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">GEODESICSCALE</span><span class="p">:</span>
      <span class="n">result</span><span class="p">[</span><span class="s1">&#39;M12&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">M12</span><span class="p">;</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;M21&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">M21</span>
    <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">AREA</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;S12&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">S12</span>
    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Geodesic.ArcDirect"><a class="viewcode-back" href="../../_generated/network_wrangler.utils.html#network_wrangler.utils.Geodesic.ArcDirect">[docs]</a>  <span class="k">def</span> <span class="nf">ArcDirect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">azi1</span><span class="p">,</span> <span class="n">a12</span><span class="p">,</span>
                <span class="n">outmask</span> <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">STANDARD</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Solve the direct geodesic problem in terms of spherical arc length</span>

<span class="sd">    :param lat1: latitude of the first point in degrees</span>
<span class="sd">    :param lon1: longitude of the first point in degrees</span>
<span class="sd">    :param azi1: azimuth at the first point in degrees</span>
<span class="sd">    :param a12: spherical arc length from the first point to the second</span>
<span class="sd">      in degrees</span>
<span class="sd">    :param outmask: the :ref:`output mask &lt;outmask&gt;`</span>
<span class="sd">    :return: a :ref:`dict`</span>

<span class="sd">    Compute geodesic starting at (*lat1*, *lon1*) with azimuth *azi1*</span>
<span class="sd">    and arc length *a12*.  The default value of *outmask* is STANDARD,</span>
<span class="sd">    i.e., the *lat1*, *lon1*, *azi1*, *lat2*, *lon2*, *azi2*, *s12*,</span>
<span class="sd">    *a12* entries are returned.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">a12</span><span class="p">,</span> <span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span><span class="p">,</span> <span class="n">azi2</span><span class="p">,</span> <span class="n">s12</span><span class="p">,</span> <span class="n">m12</span><span class="p">,</span> <span class="n">M12</span><span class="p">,</span> <span class="n">M21</span><span class="p">,</span> <span class="n">S12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GenDirect</span><span class="p">(</span>
      <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">azi1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">a12</span><span class="p">,</span> <span class="n">outmask</span><span class="p">)</span>
    <span class="n">outmask</span> <span class="o">&amp;=</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">OUT_MASK</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lat1&#39;</span><span class="p">:</span> <span class="n">Math</span><span class="o">.</span><span class="n">LatFix</span><span class="p">(</span><span class="n">lat1</span><span class="p">),</span>
              <span class="s1">&#39;lon1&#39;</span><span class="p">:</span> <span class="n">lon1</span> <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">LONG_UNROLL</span> <span class="k">else</span>
              <span class="n">Math</span><span class="o">.</span><span class="n">AngNormalize</span><span class="p">(</span><span class="n">lon1</span><span class="p">),</span>
              <span class="s1">&#39;azi1&#39;</span><span class="p">:</span> <span class="n">Math</span><span class="o">.</span><span class="n">AngNormalize</span><span class="p">(</span><span class="n">azi1</span><span class="p">),</span>
              <span class="s1">&#39;a12&#39;</span><span class="p">:</span> <span class="n">a12</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">DISTANCE</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;s12&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s12</span>
    <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">LATITUDE</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;lat2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat2</span>
    <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">LONGITUDE</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;lon2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lon2</span>
    <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">AZIMUTH</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;azi2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">azi2</span>
    <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">REDUCEDLENGTH</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;m12&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m12</span>
    <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">GEODESICSCALE</span><span class="p">:</span>
      <span class="n">result</span><span class="p">[</span><span class="s1">&#39;M12&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">M12</span><span class="p">;</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;M21&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">M21</span>
    <span class="k">if</span> <span class="n">outmask</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">AREA</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;S12&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">S12</span>
    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Geodesic.Line"><a class="viewcode-back" href="../../_generated/network_wrangler.utils.html#network_wrangler.utils.Geodesic.Line">[docs]</a>  <span class="k">def</span> <span class="nf">Line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">azi1</span><span class="p">,</span>
           <span class="n">caps</span> <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">STANDARD</span> <span class="o">|</span>
           <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">DISTANCE_IN</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a GeodesicLine object</span>

<span class="sd">    :param lat1: latitude of the first point in degrees</span>
<span class="sd">    :param lon1: longitude of the first point in degrees</span>
<span class="sd">    :param azi1: azimuth at the first point in degrees</span>
<span class="sd">    :param caps: the :ref:`capabilities &lt;outmask&gt;`</span>
<span class="sd">    :return: a :class:`~geographiclib.geodesicline.GeodesicLine`</span>

<span class="sd">    This allows points along a geodesic starting at (*lat1*, *lon1*),</span>
<span class="sd">    with azimuth *azi1* to be found.  The default value of *caps* is</span>
<span class="sd">    STANDARD | DISTANCE_IN, allowing direct geodesic problem to be</span>
<span class="sd">    solved.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">geographiclib.geodesicline</span> <span class="kn">import</span> <span class="n">GeodesicLine</span>
    <span class="k">return</span> <span class="n">GeodesicLine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">azi1</span><span class="p">,</span> <span class="n">caps</span><span class="p">)</span></div>

  <span class="k">def</span> <span class="nf">_GenDirectLine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">azi1</span><span class="p">,</span> <span class="n">arcmode</span><span class="p">,</span> <span class="n">s12_a12</span><span class="p">,</span>
                     <span class="n">caps</span> <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">STANDARD</span> <span class="o">|</span>
                     <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">DISTANCE_IN</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Private: general form of DirectLine&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">geographiclib.geodesicline</span> <span class="kn">import</span> <span class="n">GeodesicLine</span>
    <span class="c1"># Automatically supply DISTANCE_IN if necessary</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">arcmode</span><span class="p">:</span> <span class="n">caps</span> <span class="o">|=</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">DISTANCE_IN</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">GeodesicLine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">azi1</span><span class="p">,</span> <span class="n">caps</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">arcmode</span><span class="p">:</span>
      <span class="n">line</span><span class="o">.</span><span class="n">SetArc</span><span class="p">(</span><span class="n">s12_a12</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">line</span><span class="o">.</span><span class="n">SetDistance</span><span class="p">(</span><span class="n">s12_a12</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">line</span>

<div class="viewcode-block" id="Geodesic.DirectLine"><a class="viewcode-back" href="../../_generated/network_wrangler.utils.html#network_wrangler.utils.Geodesic.DirectLine">[docs]</a>  <span class="k">def</span> <span class="nf">DirectLine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">azi1</span><span class="p">,</span> <span class="n">s12</span><span class="p">,</span>
                 <span class="n">caps</span> <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">STANDARD</span> <span class="o">|</span>
                 <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">DISTANCE_IN</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Define a GeodesicLine object in terms of the direct geodesic</span>
<span class="sd">    problem specified in terms of spherical arc length</span>

<span class="sd">    :param lat1: latitude of the first point in degrees</span>
<span class="sd">    :param lon1: longitude of the first point in degrees</span>
<span class="sd">    :param azi1: azimuth at the first point in degrees</span>
<span class="sd">    :param s12: the distance from the first point to the second in</span>
<span class="sd">      meters</span>
<span class="sd">    :param caps: the :ref:`capabilities &lt;outmask&gt;`</span>
<span class="sd">    :return: a :class:`~geographiclib.geodesicline.GeodesicLine`</span>

<span class="sd">    This function sets point 3 of the GeodesicLine to correspond to</span>
<span class="sd">    point 2 of the direct geodesic problem.  The default value of *caps*</span>
<span class="sd">    is STANDARD | DISTANCE_IN, allowing direct geodesic problem to be</span>
<span class="sd">    solved.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GenDirectLine</span><span class="p">(</span><span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">azi1</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">s12</span><span class="p">,</span> <span class="n">caps</span><span class="p">)</span></div>

<div class="viewcode-block" id="Geodesic.ArcDirectLine"><a class="viewcode-back" href="../../_generated/network_wrangler.utils.html#network_wrangler.utils.Geodesic.ArcDirectLine">[docs]</a>  <span class="k">def</span> <span class="nf">ArcDirectLine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">azi1</span><span class="p">,</span> <span class="n">a12</span><span class="p">,</span>
                 <span class="n">caps</span> <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">STANDARD</span> <span class="o">|</span>
                 <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">DISTANCE_IN</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Define a GeodesicLine object in terms of the direct geodesic</span>
<span class="sd">    problem specified in terms of spherical arc length</span>

<span class="sd">    :param lat1: latitude of the first point in degrees</span>
<span class="sd">    :param lon1: longitude of the first point in degrees</span>
<span class="sd">    :param azi1: azimuth at the first point in degrees</span>
<span class="sd">    :param a12: spherical arc length from the first point to the second</span>
<span class="sd">      in degrees</span>
<span class="sd">    :param caps: the :ref:`capabilities &lt;outmask&gt;`</span>
<span class="sd">    :return: a :class:`~geographiclib.geodesicline.GeodesicLine`</span>

<span class="sd">    This function sets point 3 of the GeodesicLine to correspond to</span>
<span class="sd">    point 2 of the direct geodesic problem.  The default value of *caps*</span>
<span class="sd">    is STANDARD | DISTANCE_IN, allowing direct geodesic problem to be</span>
<span class="sd">    solved.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GenDirectLine</span><span class="p">(</span><span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">azi1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">a12</span><span class="p">,</span> <span class="n">caps</span><span class="p">)</span></div>

<div class="viewcode-block" id="Geodesic.InverseLine"><a class="viewcode-back" href="../../_generated/network_wrangler.utils.html#network_wrangler.utils.Geodesic.InverseLine">[docs]</a>  <span class="k">def</span> <span class="nf">InverseLine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span><span class="p">,</span>
                  <span class="n">caps</span> <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">STANDARD</span> <span class="o">|</span>
                  <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">DISTANCE_IN</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Define a GeodesicLine object in terms of the invese geodesic problem</span>

<span class="sd">    :param lat1: latitude of the first point in degrees</span>
<span class="sd">    :param lon1: longitude of the first point in degrees</span>
<span class="sd">    :param lat2: latitude of the second point in degrees</span>
<span class="sd">    :param lon2: longitude of the second point in degrees</span>
<span class="sd">    :param caps: the :ref:`capabilities &lt;outmask&gt;`</span>
<span class="sd">    :return: a :class:`~geographiclib.geodesicline.GeodesicLine`</span>

<span class="sd">    This function sets point 3 of the GeodesicLine to correspond to</span>
<span class="sd">    point 2 of the inverse geodesic problem.  The default value of *caps*</span>
<span class="sd">    is STANDARD | DISTANCE_IN, allowing direct geodesic problem to be</span>
<span class="sd">    solved.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">geographiclib.geodesicline</span> <span class="kn">import</span> <span class="n">GeodesicLine</span>
    <span class="n">a12</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">salp1</span><span class="p">,</span> <span class="n">calp1</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GenInverse</span><span class="p">(</span>
      <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">azi1</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="n">atan2d</span><span class="p">(</span><span class="n">salp1</span><span class="p">,</span> <span class="n">calp1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">caps</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Geodesic</span><span class="o">.</span><span class="n">OUT_MASK</span> <span class="o">&amp;</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">DISTANCE_IN</span><span class="p">):</span>
      <span class="n">caps</span> <span class="o">|=</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">DISTANCE</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">GeodesicLine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">azi1</span><span class="p">,</span> <span class="n">caps</span><span class="p">,</span> <span class="n">salp1</span><span class="p">,</span> <span class="n">calp1</span><span class="p">)</span>
    <span class="n">line</span><span class="o">.</span><span class="n">SetArc</span><span class="p">(</span><span class="n">a12</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">line</span></div>

<div class="viewcode-block" id="Geodesic.Polygon"><a class="viewcode-back" href="../../_generated/network_wrangler.utils.html#network_wrangler.utils.Geodesic.Polygon">[docs]</a>  <span class="k">def</span> <span class="nf">Polygon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">polyline</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a PolygonArea object</span>

<span class="sd">    :param polyline: if True then the object describes a polyline</span>
<span class="sd">      instead of a polygon</span>
<span class="sd">    :return: a :class:`~geographiclib.polygonarea.PolygonArea`</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">geographiclib.polygonarea</span> <span class="kn">import</span> <span class="n">PolygonArea</span>
    <span class="k">return</span> <span class="n">PolygonArea</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">polyline</span><span class="p">)</span></div>

  <span class="n">EMPTY</span>         <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">EMPTY</span>
  <span class="sd">&quot;&quot;&quot;No capabilities, no output.&quot;&quot;&quot;</span>
  <span class="n">LATITUDE</span>      <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">LATITUDE</span>
  <span class="sd">&quot;&quot;&quot;Calculate latitude *lat2*.&quot;&quot;&quot;</span>
  <span class="n">LONGITUDE</span>     <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">LONGITUDE</span>
  <span class="sd">&quot;&quot;&quot;Calculate longitude *lon2*.&quot;&quot;&quot;</span>
  <span class="n">AZIMUTH</span>       <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">AZIMUTH</span>
  <span class="sd">&quot;&quot;&quot;Calculate azimuths *azi1* and *azi2*.&quot;&quot;&quot;</span>
  <span class="n">DISTANCE</span>      <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">DISTANCE</span>
  <span class="sd">&quot;&quot;&quot;Calculate distance *s12*.&quot;&quot;&quot;</span>
  <span class="n">STANDARD</span>      <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">STANDARD</span>
  <span class="sd">&quot;&quot;&quot;All of the above.&quot;&quot;&quot;</span>
  <span class="n">DISTANCE_IN</span>   <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">DISTANCE_IN</span>
  <span class="sd">&quot;&quot;&quot;Allow distance *s12* to be used as input in the direct geodesic</span>
<span class="sd">  problem.&quot;&quot;&quot;</span>
  <span class="n">REDUCEDLENGTH</span> <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">REDUCEDLENGTH</span>
  <span class="sd">&quot;&quot;&quot;Calculate reduced length *m12*.&quot;&quot;&quot;</span>
  <span class="n">GEODESICSCALE</span> <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">GEODESICSCALE</span>
  <span class="sd">&quot;&quot;&quot;Calculate geodesic scales *M12* and *M21*.&quot;&quot;&quot;</span>
  <span class="n">AREA</span>          <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">AREA</span>
  <span class="sd">&quot;&quot;&quot;Calculate area *S12*.&quot;&quot;&quot;</span>
  <span class="n">ALL</span>           <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">ALL</span>
  <span class="sd">&quot;&quot;&quot;All of the above.&quot;&quot;&quot;</span>
  <span class="n">LONG_UNROLL</span>   <span class="o">=</span> <span class="n">GeodesicCapability</span><span class="o">.</span><span class="n">LONG_UNROLL</span>
  <span class="sd">&quot;&quot;&quot;Unroll longitudes, rather than reducing them to the range</span>
<span class="sd">  [-180d,180d].</span>

<span class="sd">  &quot;&quot;&quot;</span></div>

<span class="n">Geodesic</span><span class="o">.</span><span class="n">WGS84</span> <span class="o">=</span> <span class="n">Geodesic</span><span class="p">(</span><span class="n">Constants</span><span class="o">.</span><span class="n">WGS84_a</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">WGS84_f</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;Instantiation for the WGS84 ellipsoid&quot;&quot;&quot;</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Metropolitan Council

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>